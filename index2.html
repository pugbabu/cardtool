<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦å…¨èƒ½å¡ç‰‡å·¥å‚ (å°é¢+æ­£æ–‡)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #2A00FF;
            --primary-light: rgba(42, 0, 255, 0.1); 
            --bg-light: #F2F4F8;
            --border: #E0E0E0;
            --text-main: #333;
            --card-w: 600px;
            --card-h: 800px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-light); font-family: 'PingFang SC', sans-serif; color: var(--text-main); height: 100vh; overflow: hidden; }
        
        /* å¸ƒå±€æ¡†æ¶ */
        .app-container { display: flex; height: 100vh; max-width: 1800px; margin: 0 auto; }
        
        /* å·¦ä¾§é…ç½®æ  */
        .config-panel { width: 460px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .tab-group { display: flex; background: #f0f0f0; padding: 4px; border-radius: 8px; margin-top: 15px; }
        .tab-btn { flex: 1; border: none; background: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; color: #666; transition: 0.2s; }
        .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .panel-body { flex: 1; overflow-y: auto; padding: 20px; }
        .config-section { display: none; }
        .config-section.active { display: block; }

        /* è¡¨å•ç»„ä»¶ */
        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 13px; font-weight: 700; color: #555; margin-bottom: 8px; display: block; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; transition: 0.2s; }
        .form-control:focus { border-color: var(--primary); outline: none; }
        
        /* é¢œè‰²é€‰æ‹© */
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .color-dot { padding-bottom: 100%; border-radius: 50%; cursor: pointer; position: relative; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot.active { transform: scale(1.1); border-color: #333; }

        /* è¡¨æƒ…é€‰æ‹©å™¨ */
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .emoji-btn { border: none; background: none; font-size: 20px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .emoji-btn:hover { background: #eee; }

        /* æ¨¡æ¿é€‰æ‹©å¡ç‰‡ */
        .template-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .template-card { border: 2px solid #eee; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; font-size: 12px; }
        .template-card.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
        .template-preview-box { height: 40px; background: #ddd; margin-bottom: 5px; border-radius: 4px; }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { flex: 1; background: #E1E4E8; display: flex; justify-content: center; align-items: center; padding: 40px; overflow: hidden; }
        
        /* æ ¸å¿ƒå®šä½ */
        .canvas-wrapper { 
            position: relative; 
            width: var(--card-w);
            height: var(--card-h);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
            border-radius: 12px; 
            overflow: hidden; 
            transform-origin: center center;
        }
        
        /* ç”»å¸ƒé€šç”¨ */
        .xhs-canvas { 
            width: var(--card-w); 
            height: var(--card-h); 
            background: #fff; 
            position: absolute; 
            top: 0;
            left: 0;
            overflow: hidden; 
            display: none; 
        }
        .xhs-canvas.active { 
            display: flex; 
        }

        /* === å°é¢è®¾è®¡æ ·å¼ (ä¿æŒä¸å˜) === */
        .cover-canvas { flex-direction: column; color: #fff; }
        .tpl-thinking { background: var(--primary); justify-content: center; align-items: center; padding: 60px; text-align: center; }
        .tpl-thinking .cover-icon { font-size: 120px; margin-bottom: 30px; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
        .tpl-thinking .cover-title { font-size: 72px; font-weight: 900; line-height: 1.2; text-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .tpl-thinking .cover-subtitle { background: #fff; color: var(--primary); padding: 10px 30px; border-radius: 50px; font-size: 28px; font-weight: 700; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tpl-tutorial { background: #f5f5f7; padding: 40px; }
        .tpl-tutorial::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 35%; background: var(--primary); z-index: 0; }
        .tpl-tutorial .tutorial-card { background: #fff; border-radius: 20px; flex: 1; z-index: 1; margin-top: 60px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; }
        .tpl-tutorial .cover-tag { position: absolute; top: -25px; background: #000; color: #fff; padding: 12px 30px; border-radius: 12px; font-size: 20px; font-weight: bold; }
        .tpl-tutorial .cover-title { color: #333; font-size: 64px; font-weight: 900; line-height: 1.3; margin-bottom: 20px; }
        .tpl-tutorial .cover-title span { color: var(--primary); }
        .tpl-tutorial .cover-subtitle { font-size: 24px; color: #666; margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; width: 100%; }
        .tpl-tutorial .cover-icon { font-size: 80px; margin-bottom: 20px; }
        .tpl-emotion { background: linear-gradient(135deg, #111, #333); color: #fff; padding: 40px; justify-content: space-between; }
        .tpl-emotion .emotion-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .tpl-emotion .cover-icon { font-size: 100px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 10px; backdrop-filter: blur(10px); }
        .tpl-emotion .cover-date { font-size: 24px; font-family: monospace; opacity: 0.6; }
        .tpl-emotion .cover-title { font-size: 80px; font-weight: 900; line-height: 1.1; margin-top: auto; margin-bottom: 40px; }
        .tpl-emotion .cover-subtitle { font-size: 32px; color: var(--primary); font-weight: bold; background: rgba(0,0,0,0.5); padding: 15px; border-left: 8px solid var(--primary); }

        /* === æ­£æ–‡è®¾è®¡æ ·å¼ === */
        .step-canvas { flex-direction: column; background: #fff; }
        .step-header { padding: 30px 40px 15px; border-bottom: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: baseline; }
        .step-num { font-size: 72px; font-weight: 900; color: var(--primary); font-style: italic; line-height: 0.8; }
        .step-header-text { text-align: right; }
        .step-header-en { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #000; letter-spacing: 1px; }
        .step-header-title { font-size: 24px; font-weight: 800; color: #000; margin-top: 4px; }
        
        .step-body { padding: 30px 40px; flex: 1; }
        
        /* æ—¶é—´è½´å¸ƒå±€ */
        .step-item { 
            display: flex; 
            margin-bottom: 25px; 
            position: relative;
            align-items: stretch; 
        }
        .step-left { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 30px; 
            margin-right: 20px;
            flex-shrink: 0;
        }
        .step-idx { 
            width: 30px; 
            height: 30px; 
            background: var(--primary); 
            color: #fff; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            flex-shrink: 0; 
            z-index: 1; 
        }
        .step-line-segment {
            flex-grow: 1; 
            width: 2px;
            background: #eee;
            margin-top: 5px; 
            margin-bottom: -5px; 
        }
        .step-item:last-child .step-line-segment {
            display: none; 
        }
        .step-right { flex: 1; }

        /* === ç»„ä»¶æ ·å¼ === */
        
        /* æç¤ºè¯å— */
        .comp-prompt { 
            background: #f8f9fa; 
            border-left: 4px solid var(--primary); 
            padding: 12px; 
            font-family: monospace; 
            font-size: 13px; 
            color: #444; 
            margin-top: 6px; 
            white-space: pre-wrap; 
            word-break: break-all;
        }
        
        /* å›¾ç‰‡å— */
        .comp-img { border: 1px solid #eee; border-radius: 6px; overflow: hidden; margin-top: 6px; }
        .comp-img img { width: 100%; display: block; }

        /* æ ‡ç­¾ */
        .comp-tag { display: inline-block; background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; }

        /* é€‰é¡¹/åˆ—è¡¨ */
        .comp-option {
            display: flex;
            align-items: flex-start;
            margin-top: 6px;
        }
        .comp-option .option-bullet {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2px;
            margin-right: 10px;
            flex-shrink: 0;
            font-weight: bold;
        }
        .comp-option .option-text {
            font-size: 15px;
            line-height: 1.5;
        }
        
        /* æç¤ºã€æˆåŠŸã€è­¦å‘ŠçŠ¶æ€å— */
        .comp-status-box {
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 6px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* è´´å£« (Tip) */
        .comp-tip {
            background: var(--primary-light); 
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        /* æˆåŠŸ (Success) */
        .comp-success {
            background: rgba(0, 196, 140, 0.1); 
            border: 1px solid #00C48C;
            color: #00C48C;
        }

        /* è­¦å‘Š (Warning) */
        .comp-warning {
            background: rgba(255, 125, 0, 0.1); 
            border: 1px solid #FF7D00;
            color: #FF7D00;
        }


        /* å¯¼å‡ºé®ç½© */
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: #fff; display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æ­¥éª¤ç¼–è¾‘å™¨æ ·å¼ */
        .step-edit-card { background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .step-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: bold; color: #666; cursor: move; }
        .block-list { display: flex; flex-direction: column; gap: 5px; }
        .block-item { display: flex; gap: 5px; align-items: flex-start; } /* ä½¿ç”¨ flex-start ä¿®å¤ textarea é¡¶éƒ¨å¯¹é½é—®é¢˜ */
        .block-btn-bar { margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap; }
        .tiny-btn { font-size: 11px; padding: 3px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .tiny-btn:hover { color: var(--primary); border-color: var(--primary); }
        
        /* æ ¸å¿ƒä¿®å¤ï¼šTextarea è‡ªåŠ¨é«˜åº¦æ ·å¼ */
        .block-item textarea.form-control {
            padding: 5px; 
            font-size: 12px; 
            height: auto; 
            min-height: 35px; /* æœ€å°é«˜åº¦ */
            overflow-y: hidden; 
            resize: none; /* ç¦ç”¨ç”¨æˆ·æ‹–æ‹½è°ƒæ•´å¤§å° */
        }

    </style>
</head>
<body>

<div class="app-container">
    <div class="config-panel">
        <div class="panel-header">
            <h2 style="font-size:18px;">ğŸ¨ å°çº¢ä¹¦å…¨èƒ½å·¥å‚</h2>
            <div class="tab-group" id="tabGroup">
                <button class="tab-btn active" onclick="switchTab('cover', this)">å°é¢è®¾è®¡</button>
                <button class="tab-btn" onclick="switchTab('content', this)">æ­£æ–‡åˆ¶ä½œ</button>
            </div>
        </div>

        <div class="panel-body">
            <div class="form-group">
                <label class="form-label">ä¸»é¢˜é…è‰²</label>
                <div class="color-grid" id="themeColors"></div>
            </div>

            <div id="config-cover" class="config-section active">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ¨¡æ¿</label>
                    <div class="template-grid">
                        <div class="template-card active" onclick="setCoverTemplate('thinking')">
                            <div class="template-preview-box" style="background:var(--primary)"></div>
                            æ€è€ƒä¸“ä¸š
                        </div>
                        <div class="template-card" onclick="setCoverTemplate('tutorial')">
                            <div class="template-preview-box" style="background:#eee; border:1px solid #ccc"></div>
                            å¡ç‰‡æ•™ç¨‹
                        </div>
                        <div class="template-card" onclick="setCoverTemplate('emotion')">
                            <div class="template-preview-box" style="background:linear-gradient(45deg,#333,#000)"></div>
                            æƒ…ç»ªå¤§å­—
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å°é¢å†…å®¹</label>
                    <input type="text" class="form-control mb-2" id="coverTitle" placeholder="ä¸»æ ‡é¢˜ (å¦‚: 3åˆ†é’Ÿå­¦ä¼š)" value="DeepSeek">
                    <input type="text" class="form-control mb-2" id="coverSubtitle" placeholder="å‰¯æ ‡é¢˜/é«˜äº® (å¦‚: é™„ä¿å§†çº§æ•™ç¨‹)" value="ç”Ÿæˆä¸“å±æç¤ºè¯">
                    <div style="margin-top:5px; font-size:12px; color:#999;">* æ•™ç¨‹æ¨¡æ¿ä¸‹ï¼Œå‰¯æ ‡é¢˜æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼›æ€è€ƒæ¨¡æ¿ä¸‹ï¼Œå‰¯æ ‡é¢˜ä¸ºèƒ¶å›Šæ ·å¼</div>
                </div>

                <div class="form-group">
                    <label class="form-label">è£…é¥°å›¾æ ‡ (Emoji)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" class="form-control" id="coverIcon" value="ğŸ¤–" style="width:60px; text-align:center; font-size:20px;">
                        <div style="flex:1; font-size:12px; color:#999; display:flex; align-items:center;">ç‚¹å‡»ä¸‹æ–¹å¿«é€Ÿé€‰æ‹© ğŸ‘‡</div>
                    </div>
                    <div class="emoji-grid" id="emojiPicker">
                        </div>
                </div>
            </div>

            <div id="config-content" class="config-section">
                <div class="form-group">
                    <label class="form-label">é¡µçœ‰è®¾ç½®</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" class="form-control" id="stepNum" value="01" style="width:60px;">
                        <input type="text" class="form-control" id="stepTitle" value="ç”Ÿæˆä¸“å±æç¤ºè¯">
                    </div>
                </div>

                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label class="form-label">æ­¥éª¤å†…å®¹</label>
                        <button class="tiny-btn" style="background:var(--primary); color:#fff; border:none;" onclick="addStep()">+ åŠ æ­¥éª¤</button>
                    </div>
                    <div id="stepsContainer">
                        </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">åº•éƒ¨æé†’</label>
                    <textarea class="form-control" id="footerText">ğŸ“Œ å»ºè®®æ”¶è—ï¼Œéšæ—¶æŸ¥é˜…</textarea>
                </div>
            </div>
        </div>

        <div style="padding:20px; border-top:1px solid #eee; display:flex; gap:10px;">
            <button class="form-control" style="background:var(--primary); color:#fff; font-weight:bold; border:none;" onclick="exportImage()">ğŸ“¸ å¯¼å‡ºå½“å‰å›¾ç‰‡</button>
        </div>
    </div>

    <div class="preview-area">
        <div class="canvas-wrapper">
            <div id="canvas-cover" class="xhs-canvas cover-canvas tpl-thinking active">
                </div>
            
            <div id="canvas-content" class="xhs-canvas step-canvas">
                </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <p>æ­£åœ¨ç”Ÿæˆé«˜æ¸…å¤§å›¾...</p>
</div>

<script>
    // === æ•°æ®çŠ¶æ€ ===
    const state = {
        theme: '#2A00FF',
        tab: 'cover', // cover | content
        cover: {
            template: 'thinking', // thinking | tutorial | emotion
            title: 'DeepSeek',
            subtitle: 'ç”Ÿæˆä¸“å±æç¤ºè¯',
            icon: 'ğŸ¤–'
        },
        content: {
            num: '01',
            en: 'STEP ONE',
            title: 'ç”Ÿæˆä¸“å±æç¤ºè¯',
            steps: [
                { id: 1, blocks: [
                    {type:'text', val:'æ‰“å¼€ <span class="comp-tag">DeepSeek</span> å®˜ç½‘'},
                    {type:'image', val:'https://picsum.photos/500/250'} 
                ]},
                { id: 2, blocks: [
                    {type:'text', val:'å¤åˆ¶ä¸‹æ–¹æç¤ºè¯ï¼š'},
                    {type:'prompt', val:'ğŸ’» æç¤ºè¯å†…å®¹...'} 
                ]},
                { id: 3, blocks: [
                    {type:'option', val:'ç¬¬ä¸€æ­¥æ“ä½œ'},
                    {type:'option', val:'ç¬¬äºŒæ­¥æ“ä½œ'},
                    {type:'tip', val:'ğŸ’¡ é‡ç‚¹ï¼šæ³¨æ„å›¾ç‰‡ç‰ˆæƒï¼Œå»ºè®®ä½¿ç”¨è‡ªå·±æˆªå›¾'} 
                ]},
                { id: 4, blocks: [
                    {type:'success', val:'âœ… æ­å–œï¼šæ“ä½œæˆåŠŸå®Œæˆ'},
                    {type:'warning', val:'âš ï¸ è­¦å‘Šï¼šè¯·å‹¿æ³„éœ²ä¸ªäººä¿¡æ¯'}
                ]}
            ],
            footer: 'ğŸ“Œ å»ºè®®æ”¶è—ï¼Œéšæ—¶æŸ¥é˜…'
        }
    };

    const EMOJIS = ['ğŸ¤–','âœ¨','ğŸ”¥','ğŸ’¡','ğŸ“š','ğŸ¨','âœ…','âš ï¸','ğŸŒŸ','ğŸ’¬','ğŸ“…','ğŸš€','ğŸ’»','ğŸ“±','ğŸ“','ğŸ’¼'];
    const COLORS = ['#2A00FF', '#FF2442', '#00C48C', '#FF7D00', '#7B61FF', '#222222'];

    // å®Œæ•´çš„ç»„ä»¶ç±»å‹åˆ°ä¸­æ–‡æ ‡ç­¾æ˜ å°„
    const BLOCK_TYPE_LABELS = {
        'text': 'ğŸ“ æ–‡æœ¬',
        'prompt': 'ğŸ’» æç¤ºè¯',
        'image': 'ğŸ–¼ï¸ å›¾ç‰‡',
        'option': 'ğŸ”˜ é€‰é¡¹',
        'tip': 'ğŸ’¡ è´´å£«',
        'success': 'âœ… æˆåŠŸ',
        'warning': 'âš ï¸ è­¦å‘Š'
    };
    
    // === åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
        initColors();
        initEmojis();
        renderStepsEditor();
        renderAll();

        // ç»‘å®šè¾“å…¥ç›‘å¬
        bindInput('coverTitle', (v) => { state.cover.title = v; renderCover(); });
        bindInput('coverSubtitle', (v) => { state.cover.subtitle = v; renderCover(); });
        bindInput('coverIcon', (v) => { state.cover.icon = v; renderCover(); });
        bindInput('stepNum', (v) => { 
            state.content.num = v; 
            state.content.en = convertNumToEnglish(v); // è‡ªåŠ¨è½¬æ¢é¡µçœ‰è‹±æ–‡
            renderContent(); 
        });
        bindInput('stepTitle', (v) => { state.content.title = v; renderContent(); });
        bindInput('footerText', (v) => { state.content.footer = v; renderContent(); });

        // æ­¥éª¤æ‹–æ‹½ (æ­¥éª¤å¡ç‰‡)
        new Sortable(document.getElementById('stepsContainer'), {
            handle: '.step-top',
            animation: 150,
            onEnd: () => {
                updateStateFromDom();
            }
        });
    });

    // === æ ¸å¿ƒé€»è¾‘ï¼šåˆ‡æ¢ Tab å’Œä¸»é¢˜è‰² ===
    function switchTab(tab, btn) {
        state.tab = tab;
        
        // 1. åˆ‡æ¢æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // 2. åˆ‡æ¢é…ç½®é¢æ¿
        document.querySelectorAll('.config-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`config-${tab}`).classList.add('active');

        // 3. åˆ‡æ¢é¢„è§ˆç”»å¸ƒ 
        document.getElementById('canvas-cover').classList.remove('active');
        document.getElementById('canvas-content').classList.remove('active');
        document.getElementById(`canvas-${tab}`).classList.add('active');
    }

    function setCoverTemplate(tpl) {
        state.cover.template = tpl;
        document.querySelectorAll('.template-card').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderCover();
    }

    function setTheme(color) {
        state.theme = color;
        // è‡ªåŠ¨è®¡ç®—ä¸€ä¸ªæµ…è‰²é€æ˜èƒŒæ™¯ for primary-light (10% opacity)
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '42, 0, 255';
        };
        const rgb = hexToRgb(color);
        const primaryLightRgba = `rgba(${rgb}, 0.1)`; 

        document.documentElement.style.setProperty('--primary', color);
        document.documentElement.style.setProperty('--primary-light', primaryLightRgba); 

        document.querySelectorAll('.color-dot').forEach(el => {
            el.classList.toggle('active', el.dataset.color === color);
        });
        renderAll();
    }

    // === æ¸²æŸ“é€»è¾‘ï¼šåªç®¡å†…å®¹ï¼Œä¸ç®¡æ˜¾ç¤ºçŠ¶æ€ ===

    function renderAll() {
        renderCover();
        renderContent();
    }

    function renderCover() {
        const c = state.cover;
        const el = document.getElementById('canvas-cover');
        el.className = `xhs-canvas cover-canvas tpl-${c.template}`; 

        let html = '';
        if (c.template === 'thinking') {
            html = `
                <div class="cover-icon">${c.icon}</div>
                <div class="cover-title">${c.title}</div>
                <div class="cover-subtitle">${c.subtitle}</div>
            `;
        } else if (c.template === 'tutorial') {
            const titleHtml = c.title.length > 2 
                ? c.title.replace(/(.{2})$/, '<span>$1</span>') 
                : `<span>${c.title}</span>`;
            
            html = `
                <div class="tutorial-card">
                    <div class="cover-tag">ä¿å§†çº§æ•™ç¨‹</div>
                    <div class="cover-icon">${c.icon}</div>
                    <div class="cover-title">${titleHtml}</div>
                    <div class="cover-subtitle">${c.subtitle}</div>
                </div>
            `;
        } else if (c.template === 'emotion') {
            const date = new Date().toLocaleDateString('zh-CN', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
            html = `
                <div class="emotion-top">
                    <div class="cover-icon">${c.icon}</div>
                    <div class="cover-date">${date}</div>
                </div>
                <div>
                    <div class="cover-title">${c.title}</div>
                    <div class="cover-subtitle">${c.subtitle}</div>
                </div>
            `;
        }
        el.innerHTML = html;
        el.style.display = 'flex'; 
    }

    function renderContent() {
        const c = state.content;
        
        const currentSteps = state.content.steps.slice(); 
        
        const listHtml = currentSteps.map((step, i) => {
            const blocks = step.blocks.map(b => {
                const valWithBreaks = b.val.replace(/\n/g, '<br>');
                
                if(b.type === 'text') return `<div style="font-size:15px; margin-bottom:4px; line-height:1.5;">${valWithBreaks}</div>`;
                if(b.type === 'prompt') return `<div class="comp-prompt">${valWithBreaks}</div>`;
                if(b.type === 'image') return `<div class="comp-img"><img src="${b.val}"></div>`;
                if(b.type === 'tip') return `<div class="comp-status-box comp-tip">ğŸ’¡ ${valWithBreaks}</div>`;
                // æ–°å¢ç»„ä»¶æ¸²æŸ“
                if(b.type === 'option') return `
                    <div class="comp-option">
                        <div class="option-bullet">ğŸ”˜</div>
                        <div class="option-text">${valWithBreaks}</div>
                    </div>`;
                if(b.type === 'success') return `<div class="comp-status-box comp-success">${valWithBreaks}</div>`;
                if(b.type === 'warning') return `<div class="comp-status-box comp-warning">${valWithBreaks}</div>`;
                
                return '';
            }).join('');

            return `
                <div class="step-item">
                    <div class="step-left">
                        <div class="step-idx">${i+1}</div>
                        <div class="step-line-segment"></div>
                    </div>
                    <div class="step-right">
                        ${blocks}
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('canvas-content').innerHTML = `
            <div class="step-header">
                <div class="step-num">${c.num}</div>
                <div class="step-header-text">
                    <div class="step-header-en">${c.en}</div>
                    <div class="step-header-title">${c.title}</div>
                </div>
            </div>
            <div class="step-body">
                ${listHtml}
            </div>
            <div style="background:#000; color:#fff; padding:20px 40px; font-size:13px;">
                ${c.footer}
            </div>
        `;
    }

    // === ç¼–è¾‘å™¨æ„å»º (ä¸çŠ¶æ€åŒæ­¥) ===

    function renderStepsEditor() {
        const div = document.getElementById('stepsContainer');
        div.innerHTML = '';
        state.content.steps.forEach((step, sIdx) => {
            const blockInputs = step.blocks.map((b, bIdx) => {
                const typeLabel = BLOCK_TYPE_LABELS[b.type] || b.type;
                
                return `
                <div class="block-item" data-block-type="${b.type}" data-block-id="${step.id}-${bIdx}">
                    <span style="font-size:12px; color:#999; width:30px; cursor:move; flex-shrink:0; margin-top: 5px;">${typeLabel}</span>
                    <textarea class="form-control" 
                              oninput="updateBlock(${sIdx}, ${bIdx}, this.value); autoResizeTextarea(this);">${b.val}</textarea>
                    <button class="tiny-btn" style="color:red; flex-shrink:0;" onclick="removeBlock(${sIdx}, ${bIdx})">Ã—</button>
                </div>
            `;
            }).join('');

            const card = document.createElement('div');
            card.className = 'step-edit-card';
            card.dataset.stepId = step.id; 
            card.innerHTML = `
                <div class="step-top">
                    <span>æ­¥éª¤ ${sIdx + 1}</span>
                    <button class="tiny-btn" onclick="removeStep(${sIdx})">åˆ é™¤</button>
                </div>
                <div class="block-list" data-step-index="${sIdx}">${blockInputs}</div>
                <div class="block-btn-bar">
                    <button class="tiny-btn" onclick="addBlock(${sIdx}, 'text')">ğŸ“ æ–‡æœ¬</button>
                    <button class="tiny-btn" onclick="addBlock(${sIdx}, 'prompt')">ğŸ’» æç¤ºè¯</button>
                    <button class="tiny-btn" onclick="addBlock(${sIdx}, 'image')">ğŸ–¼ï¸ å›¾ç‰‡</button>
                    <button class="tiny-btn" onclick="addBlock(${sIdx}, 'option')">ğŸ”˜ é€‰é¡¹</button>
                    <button class="tiny-btn" style="background:#fff3e0;" onclick="addBlock(${sIdx}, 'tip')">ğŸ’¡ è´´å£«</button>
                    <button class="tiny-btn" style="background:#e6ffed;" onclick="addBlock(${sIdx}, 'success')">âœ… æˆåŠŸ</button>
                    <button class="tiny-btn" style="background:#fff8e1;" onclick="addBlock(${sIdx}, 'warning')">âš ï¸ è­¦å‘Š</button>
                </div>
            `;
            div.appendChild(card);
            
            new Sortable(card.querySelector('.block-list'), {
                animation: 150,
                group: 'blocks',
                handle: 'span',
                onEnd: () => {
                    updateStateFromDom();
                }
            });

            // åˆå§‹æ—¶è°ƒæ•´æ‰€æœ‰ textarea é«˜åº¦
            card.querySelectorAll('textarea').forEach(textarea => {
                autoResizeTextarea(textarea);
            });
        });
    }

    // æ ¸å¿ƒå·¥å…·å‡½æ•°ï¼šè‡ªåŠ¨è°ƒæ•´ Textarea é«˜åº¦
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // === çŠ¶æ€åŒæ­¥æ“ä½œ (ç”¨äºæ‹–æ‹½) ===

    function updateStateFromDom() {
        const newSteps = [];
        document.querySelectorAll('.step-edit-card').forEach((stepCard) => {
            const blocks = [];
            stepCard.querySelectorAll('.block-item').forEach(blockItem => {
                const type = blockItem.dataset.blockType;
                const val = blockItem.querySelector('textarea').value;
                blocks.push({ type, val });
            });
            
            const oldStep = state.content.steps.find(s => s.id == stepCard.dataset.stepId);
            newSteps.push({ 
                id: oldStep ? oldStep.id : Date.now(), 
                blocks 
            });
        });

        state.content.steps = newSteps;
        renderStepsEditor();
        renderContent();
    }
    
    // === å·¥å…·å‡½æ•° (åˆå§‹åŒ–å’Œè¾“å…¥ç»‘å®šç­‰) ===

    function initColors() {
        const box = document.getElementById('themeColors');
        COLORS.forEach(c => {
            const d = document.createElement('div');
            d.className = `color-dot ${c === state.theme ? 'active' : ''}`;
            d.style.background = c;
            d.dataset.color = c;
            d.onclick = () => setTheme(c);
            box.appendChild(d);
        });
        setTheme(state.theme); // Initial theme setup
    }

    function initEmojis() {
        const box = document.getElementById('emojiPicker');
        EMOJIS.forEach(e => {
            const b = document.createElement('button');
            b.className = 'emoji-btn';
            b.innerText = e;
            b.onclick = () => {
                const iconInput = document.getElementById('coverIcon');
                iconInput.value = e;
                state.cover.icon = e;
                renderCover();
            };
            box.appendChild(b);
        });
    }

    function bindInput(id, callback) {
        document.getElementById(id).addEventListener('input', (e) => callback(e.target.value));
    }
    
    function convertNumToEnglish(numStr) {
        const num = parseInt(numStr, 10);
        const map = {
            1: 'ONE', 2: 'TWO', 3: 'THREE', 4: 'FOUR', 5: 'FIVE', 6: 'SIX', 7: 'SEVEN', 8: 'EIGHT', 9: 'NINE', 10: 'TEN'
        };
        // ç®€å•å¤„ç†ï¼Œåªæ”¯æŒ 1-10
        return 'STEP ' + (map[num] || numStr);
    }

    function addStep() {
        state.content.steps.push({ id: Date.now(), blocks: [{type:'text', val:'æ–°æ­¥éª¤å†…å®¹'}] });
        renderStepsEditor();
        renderContent();
    }
    
    function removeStep(idx) {
        state.content.steps.splice(idx, 1);
        renderStepsEditor();
        renderContent();
    }

    function addBlock(sIdx, type) {
        let val = 'æ–‡æœ¬å†…å®¹';
        if (type === 'image') val = 'https://picsum.photos/500/200';
        else if (type === 'prompt') val = 'ğŸ’» æç¤ºè¯å†…å®¹...';
        else if (type === 'tip') val = 'ğŸ’¡ é‡ç‚¹ï¼šè¿™ä¸ªæ“ä½œèƒ½èŠ‚çœä½ ä¸€åŠæ—¶é—´ï¼';
        else if (type === 'option') val = 'é€‰é¡¹å†…å®¹ï¼Œå¯ä½œä¸ºåˆ—è¡¨ä½¿ç”¨';
        else if (type === 'success') val = 'âœ… å®Œæˆï¼šæ­å–œä½ æˆåŠŸè§£é”æ–°æŠ€èƒ½ï¼';
        else if (type === 'warning') val = 'âš ï¸ æ³¨æ„ï¼šä¸è¦è½»æ˜“æ³„éœ²ä¸ªäººä¿¡æ¯ã€‚';

        state.content.steps[sIdx].blocks.push({ type, val });
        renderStepsEditor();
        renderContent();
    }

    function removeBlock(sIdx, bIdx) {
        state.content.steps[sIdx].blocks.splice(bIdx, 1);
        renderStepsEditor();
        renderContent();
    }

    function updateBlock(sIdx, bIdx, val) {
        state.content.steps[sIdx].blocks[bIdx].val = val;
        renderContent();
    }
    
    function exportImage() {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        const targetId = state.tab === 'cover' ? 'canvas-cover' : 'canvas-content';
        const target = document.getElementById(targetId);

        html2canvas(target, {
            scale: 2,
            useCORS: true,
            backgroundColor: state.tab === 'cover' && state.cover.template === 'emotion' ? null : '#ffffff'
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `å°çº¢ä¹¦_${state.tab}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            loading.style.display = 'none';
        }).catch(err => {
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å…è®¸è·¨åŸŸ: ' + err);
            loading.style.display = 'none';
        });
    }
</script>
</body>
</html>