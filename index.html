<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦æç®€å¡ç‰‡ç”Ÿæˆå™¨ (Proç‰ˆ)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #2A00FF;
            --primary-dark: #1A00CC;
            --bg-light: #F5F7FA;
            --border: #E0E0E0;
            --text-main: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-light);
            font-family: 'PingFang SC', 'Source Han Sans CN', 'Roboto', Helvetica, Arial, sans-serif;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
        }

        .tool-container {
            display: flex;
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* --- å·¦ä¾§é…ç½®é¢æ¿ --- */
        .config-panel {
            width: 450px;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-shrink: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel-title span { color: var(--primary); }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            background: #fff;
            display: flex;
            gap: 10px;
        }

        /* è¡¨å•æ§ä»¶ */
        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 14px; font-weight: 700; margin-bottom: 8px; display: block; color: #555; }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: 0.2s;
        }
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 0, 255, 0.1);
        }
        textarea.form-control { resize: vertical; min-height: 60px; font-family: inherit; }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 8px; }
        .color-item {
            width: 100%; padding-bottom: 100%; border-radius: 50%;
            cursor: pointer; position: relative; border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-item.active { border-color: #333; transform: scale(1.1); }

        /* --- æ­¥éª¤ç¼–è¾‘å™¨æ ¸å¿ƒ --- */
        .steps-wrapper { display: flex; flex-direction: column; gap: 15px; }

        .step-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        .step-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .step-card.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

        .step-header {
            background: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            cursor: move; /* æ‹–æ‹½æ‰‹æŸ„ */
        }
        .step-title { font-weight: 700; font-size: 14px; color: #444; display: flex; gap: 8px; align-items: center; }
        .step-handle { color: #999; cursor: move; }

        .step-body { padding: 10px; background: #fff; }

        /* å—åˆ—è¡¨ (Blocks) */
        .blocks-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 10px;
        }

        .block-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            position: relative;
            padding-right: 30px; /* ä¸ºåˆ é™¤æŒ‰é’®ç•™ç©º */
            font-size: 13px;
        }
        .block-item:hover { border-color: #ddd; background: #fafafa; }
        .block-label {
            font-size: 11px; color: #999; text-transform: uppercase; margin-bottom: 4px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: move;
        }
        .block-delete {
            position: absolute; right: 8px; top: 8px;
            color: #ccc; cursor: pointer; border: none; background: none; font-size: 16px;
        }
        .block-delete:hover { color: #ff4d4f; }

        /* ç»„ä»¶æ·»åŠ å·¥å…·æ  */
        .add-block-bar {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .mini-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: 1px solid #eee;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            color: #555;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .mini-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(42,0,255,0.05); }

        /* å…¨å±€æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: #fff; flex: 1; justify-content: center;}
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline:hover { background: rgba(42,0,255,0.05); }
        .btn-danger-text { color: #ff4d4f; background: none; padding: 4px; font-size: 12px; }

        /* --- å³ä¾§é¢„è§ˆåŒºåŸŸ --- */
        .preview-area {
            flex: 1;
            background: #eef1f5;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
            position: relative;
        }

        /* é¢„è§ˆå¡ç‰‡å®¹å™¨ (ç”¨äºç¼©æ”¾) */
        .card-wrapper {
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 8px;
            overflow: hidden;
            transform-origin: center top;
        }

        /* === å°çº¢ä¹¦å¡ç‰‡ CSS (æ ¸å¿ƒæ ·å¼) === */
        .xhs-card {
            width: 600px;
            min-height: 800px;
            background: #fff;
            position: relative;
            display: flex;
            flex-direction: column;
            /* å®šä¹‰CSSå˜é‡ï¼Œæ–¹ä¾¿JSåŠ¨æ€ä¿®æ”¹ */
            --accent: #2A00FF; 
            --accent-bg: rgba(42, 0, 255, 0.08);
            --black: #000;
            --gray: #666;
            --line: #eee;
        }

        /* å¡ç‰‡å¤´éƒ¨ */
        .card-head {
            padding: 30px 40px 15px;
            border-bottom: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            position: relative;
        }
        .head-num { font-size: 72px; font-weight: 900; font-style: italic; color: var(--accent); line-height: 0.8; }
        .head-text { text-align: right; }
        .head-en { display: block; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--black); }
        .head-title { font-size: 24px; font-weight: 800; color: var(--black); margin-top: 4px; }
        .deco-circle {
            position: absolute; top: 15px; right: 15px; width: 80px; height: 80px;
            border: 1px solid var(--line); border-radius: 50%; opacity: 0.5; z-index: 0;
        }

        /* å¡ç‰‡ä¸»ä½“ */
        .card-body { padding: 30px 40px; flex: 1; position: relative; }
        .timeline-line {
            position: absolute; left: 54px; top: 30px; bottom: 30px; width: 2px;
            background: var(--line); z-index: 0;
        }

        /* æ­¥éª¤è¡Œ */
        .step-row { display: flex; margin-bottom: 25px; position: relative; z-index: 1; }
        .step-idx {
            width: 30px; height: 30px; background: var(--black); color: #fff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 15px; flex-shrink: 0; margin-right: 18px; margin-top: 2px;
        }
        .step-content { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* === ç»„ä»¶æ ·å¼ === */
        /* æ–‡æœ¬ */
        .comp-text { font-size: 16px; color: #333; line-height: 1.6; font-weight: 500; }
        .comp-text strong { color: var(--accent); }

        /* æç¤ºè¯æ¡† */
        .comp-prompt {
            background: #F8F9FA; border-left: 4px solid var(--accent);
            padding: 12px 16px; font-family: monospace; font-size: 14px; color: #444;
            border-radius: 0 6px 6px 0;
        }

        /* å›¾ç‰‡ */
        .comp-image { border-radius: 8px; overflow: hidden; border: 1px solid var(--line); margin-top: 4px; }
        .comp-image img { width: 100%; display: block; object-fit: cover; }
        .comp-image-caption { background: #f5f5f5; padding: 6px; text-align: center; font-size: 12px; color: #888; }

        /* é€‰é¡¹ */
        .comp-option {
            background: var(--accent-bg); border: 1px solid rgba(0,0,0,0.05);
            border-radius: 6px; padding: 10px 14px; display: flex; gap: 8px; align-items: center;
            font-size: 14px; color: #333;
        }

        /* æˆåŠŸ/æç¤º/è­¦å‘Šé€šç”¨ */
        .comp-alert {
            padding: 10px 14px; border-radius: 0 6px 6px 0; display: flex; gap: 10px; align-items: flex-start;
            font-size: 14px; line-height: 1.5; margin-top: 4px;
        }
        .comp-alert.success { background: rgba(0, 196, 140, 0.08); border-left: 4px solid #00C48C; }
        .comp-alert.success .icon { color: #00C48C; }
        
        .comp-alert.tip { background: rgba(56, 178, 172, 0.08); border-left: 4px solid #38B2AC; }
        .comp-alert.tip .icon { color: #38B2AC; }

        .comp-alert.warning { background: rgba(255, 125, 0, 0.08); border-left: 4px solid #FF7D00; }
        .comp-alert.warning .icon { color: #FF7D00; }

        /* è¡¨æ ¼ */
        .comp-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 4px; border-radius: 6px; overflow: hidden; border: 1px solid var(--line); }
        .comp-table th { background: #f5f5f5; padding: 8px; text-align: left; font-weight: 600; border-bottom: 1px solid #ddd; }
        .comp-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .comp-table tr:last-child td { border-bottom: none; }

        /* å¡ç‰‡åº•éƒ¨ */
        .card-foot { background: var(--black); padding: 25px 40px; color: #fff; }
        .foot-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 700; font-size: 16px; }
        .foot-head i { color: var(--accent); }
        .foot-content { font-size: 13px; opacity: 0.9; line-height: 1.6; padding-left: 24px; white-space: pre-wrap; }

        /* å¯¼å‡ºçŠ¶æ€ */
        .export-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); color: #fff;
            display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="tool-container">
        <div class="config-panel">
            <div class="panel-header">
                <div class="panel-title"><span>ğŸ¨</span> å°çº¢ä¹¦å¡ç‰‡å·¥å‚ Pro</div>
            </div>

            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label">ä¸»é¢˜é…è‰²</label>
                    <div class="color-grid" id="themeColors"></div>
                    <input type="color" id="customColor" class="form-control" style="margin-top:8px; height: 36px; padding: 2px;" value="#2A00FF">
                </div>

                <div class="form-group">
                    <label class="form-label">å¡ç‰‡å¤´éƒ¨ä¿¡æ¯</label>
                    <input type="text" class="form-control mb-2" id="inputNum" placeholder="åºå· (å¦‚: 01)" value="01">
                    <input type="text" class="form-control mb-2" id="inputEn" placeholder="è‹±æ–‡æ ‡ç­¾ (å¦‚: STEP ONE)" value="STEP ONE">
                    <input type="text" class="form-control" id="inputTitle" placeholder="ä¸»æ ‡é¢˜ (å¦‚: æç®€åˆ¶ä½œæ•™ç¨‹)" value="ç”Ÿæˆä¸“å±æç¤ºè¯">
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <label class="form-label" style="margin:0;">æ­¥éª¤å†…å®¹ç¼–è¾‘</label>
                        <button class="btn btn-outline" style="padding: 4px 10px; font-size:12px;" onclick="addStep()">+ æ–°å¢æ­¥éª¤</button>
                    </div>
                    <div id="stepsList" class="steps-wrapper">
                        </div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <label class="form-label">åº•éƒ¨æé†’åŒºåŸŸ</label>
                    <textarea class="form-control" id="inputWarning" placeholder="è¾“å…¥æé†’å†…å®¹...">â€¢ åŠ¡å¿…å¤åˆ¶ "å…¨éƒ¨æç¤ºè¯"
â€¢ å»ºè®®æ”¶è—ä»¥ä¾¿éšæ—¶æŸ¥é˜…</textarea>
                </div>
            </div>

            <div class="panel-footer">
                <button class="btn btn-primary" onclick="exportImage()">ğŸ“¸ å¯¼å‡ºå›¾ç‰‡</button>
                <button class="btn btn-outline" onclick="exportHtml()">ğŸ“„ å¯¼å‡ºä»£ç </button>
            </div>
        </div>

        <div class="preview-area">
            <div class="card-wrapper" id="captureTarget">
                <div class="xhs-card" id="cardRoot">
                    </div>
            </div>
        </div>
    </div>

    <div class="export-overlay" id="exportOverlay">
        <div class="spinner"></div>
        <div>æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...</div>
    </div>

    <script>
        // --- 1. æ•°æ®çŠ¶æ€ç®¡ç† ---
        const defaultSteps = [
            {
                id: Date.now(),
                blocks: [
                    { type: 'text', content: 'æ‰“å¼€ <strong>DeepSeek</strong> å®˜ç½‘ï¼Œè¿›å…¥å¯¹è¯é¡µé¢ã€‚' },
                    { type: 'image', url: 'https://picsum.photos/600/300', caption: 'DeepSeek é¦–é¡µæˆªå›¾' }
                ]
            },
            {
                id: Date.now() + 1,
                blocks: [
                    { type: 'text', content: 'å¤åˆ¶ä¸‹æ–¹æç¤ºè¯ï¼Œç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­ï¼š' },
                    { type: 'prompt', content: '# Role: å°çº¢ä¹¦æ–‡æ¡ˆä¸“å®¶\nè¯·å¸®æˆ‘å†™ä¸€ç¯‡å…³äº...' }
                ]
            }
        ];

        let state = {
            themeColor: '#2A00FF',
            header: { num: '01', en: 'STEP ONE', title: 'ç”Ÿæˆä¸“å±æç¤ºè¯' },
            steps: JSON.parse(JSON.stringify(defaultSteps)), // Deep copy
            warning: 'â€¢ åŠ¡å¿…å¤åˆ¶ "å…¨éƒ¨æç¤ºè¯"ï¼Œé—æ¼ä¼šå½±å“ AI æ™ºèƒ½ç¨‹åº¦ã€‚\nâ€¢ å¯å‚è€ƒç« èŠ‚å››ã€Œé…å¥—æç¤ºè¯æ¨¡æ¿ã€ç›´æ¥ä½¿ç”¨ã€‚'
        };

        // ç»„ä»¶å®šä¹‰ï¼šå›¾æ ‡ã€é»˜è®¤å€¼ã€æ¸²æŸ“Input HTML
        const COMPONENTS = {
            text: { label: 'æ–‡æœ¬', icon: 'ğŸ“', default: 'è¾“å…¥æ–‡æœ¬å†…å®¹...' },
            prompt: { label: 'æç¤ºè¯', icon: 'ğŸ’»', default: 'åœ¨æ­¤è¾“å…¥æç¤ºè¯ä»£ç ...' },
            image: { label: 'å›¾ç‰‡', icon: 'ğŸ–¼ï¸', default: {url: '', caption: ''} },
            option: { label: 'é€‰é¡¹', icon: 'ğŸ”˜', default: 'é€‰é¡¹å†…å®¹' },
            success: { label: 'æˆåŠŸ', icon: 'âœ…', default: 'æ“ä½œæˆåŠŸæç¤º' },
            tip: { label: 'è´´å£«', icon: 'ğŸ’¡', default: 'å®ç”¨å°æŠ€å·§' },
            warning: { label: 'è­¦å‘Š', icon: 'âš ï¸', default: 'æ³¨æ„é£é™©äº‹é¡¹' }
        };

        const THEME_COLORS = [
            '#2A00FF', '#FF2442', '#00C48C', '#FF7D00', '#7B61FF', '#121212'
        ];

        // --- 2. åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            initColors();
            bindGlobalInputs();
            renderStepsEditor();
            renderPreview();
            
            // åˆå§‹åŒ–æ­¥éª¤åˆ—è¡¨çš„æ‹–æ‹½æ’åº
            new Sortable(document.getElementById('stepsList'), {
                handle: '.step-header',
                animation: 150,
                onEnd: function (evt) {
                    const item = state.steps.splice(evt.oldIndex, 1)[0];
                    state.steps.splice(evt.newIndex, 0, item);
                    renderPreview(); // åªæ›´æ–°é¢„è§ˆï¼Œä¸é‡æ–°æ¸²æŸ“ç¼–è¾‘å™¨ä»¥å…å¤±å»ç„¦ç‚¹
                }
            });
        });

        function initColors() {
            const container = document.getElementById('themeColors');
            THEME_COLORS.forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-item';
                div.style.backgroundColor = c;
                div.onclick = () => setTheme(c);
                if(c === state.themeColor) div.classList.add('active');
                container.appendChild(div);
            });
            document.getElementById('customColor').oninput = (e) => setTheme(e.target.value);
        }

        function setTheme(color) {
            state.themeColor = color;
            document.documentElement.style.setProperty('--primary', color);
            // æ›´æ–° UI çŠ¶æ€
            document.querySelectorAll('.color-item').forEach(el => {
                el.classList.toggle('active', el.style.backgroundColor === color || 
                                    rgbToHex(el.style.backgroundColor) === color.toLowerCase());
            });
            renderPreview();
        }

        function bindGlobalInputs() {
            ['inputNum', 'inputEn', 'inputTitle', 'inputWarning'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const key = id.replace('input', '').toLowerCase();
                    if (key === 'warning') state.warning = e.target.value;
                    else state.header[key] = e.target.value;
                    renderPreview();
                });
            });
        }

        // --- 3. æ ¸å¿ƒé€»è¾‘ï¼šæ¸²æŸ“ç¼–è¾‘å™¨ ---
        function renderStepsEditor() {
            const container = document.getElementById('stepsList');
            container.innerHTML = '';

            state.steps.forEach((step, stepIndex) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'step-card';
                stepEl.innerHTML = `
                    <div class="step-header">
                        <span class="step-title"><span class="step-handle">â˜°</span> æ­¥éª¤ ${stepIndex + 1}</span>
                        <button class="btn-danger-text" onclick="removeStep(${stepIndex})">åˆ é™¤</button>
                    </div>
                    <div class="step-body">
                        <div class="blocks-container" id="blocks-${step.id}"></div>
                        <div class="add-block-bar">
                            ${Object.keys(COMPONENTS).map(key => `
                                <button class="mini-btn" onclick="addBlock(${stepIndex}, '${key}')">
                                    ${COMPONENTS[key].icon} ${COMPONENTS[key].label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(stepEl);

                // æ¸²æŸ“è¯¥æ­¥éª¤å†…çš„ Blocks
                const blocksContainer = stepEl.querySelector(`#blocks-${step.id}`);
                step.blocks.forEach((block, blockIndex) => {
                    renderBlockInput(blocksContainer, block, stepIndex, blockIndex);
                });

                // åˆå§‹åŒ– Block çš„æ‹–æ‹½
                new Sortable(blocksContainer, {
                    handle: '.block-label',
                    animation: 150,
                    group: 'blocks', // å…è®¸è·¨æ­¥éª¤æ‹–æ‹½ (å¯é€‰)
                    onEnd: function(evt) {
                        // é€»è¾‘è¾ƒå¤æ‚ï¼Œç®€åŒ–å¤„ç†ï¼šé‡æ–°è¯»å–DOMæˆ–ç®€å•é‡ç»˜
                        // è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œæˆ‘ä»¬ä»…ä»…é‡æ–°æ¸²æŸ“æ•´ä¸ªè§†å›¾æ¥åŒæ­¥çŠ¶æ€
                        // å®é™…ç”Ÿäº§ç¯å¢ƒåº”è¯¥æ“ä½œ state æ•°ç»„
                        updateStateFromDOM(); 
                    }
                });
            });
        }

        function renderBlockInput(container, block, stepIndex, blockIndex) {
            const el = document.createElement('div');
            el.className = 'block-item';
            
            let inputHtml = '';
            if (block.type === 'image') {
                inputHtml = `
                    <input type="text" class="form-control mb-1" placeholder="å›¾ç‰‡é“¾æ¥..." value="${block.url}" oninput="updateBlockValue(${stepIndex}, ${blockIndex}, 'url', this.value)" style="margin-bottom:5px;">
                    <input type="text" class="form-control" placeholder="å›¾ç‰‡è¯´æ˜æ–‡å­—" value="${block.caption}" oninput="updateBlockValue(${stepIndex}, ${blockIndex}, 'caption', this.value)">
                `;
            } else if (block.type === 'text' || block.type === 'prompt') {
                inputHtml = `<textarea class="form-control" oninput="updateBlockValue(${stepIndex}, ${blockIndex}, 'content', this.value)">${block.content}</textarea>`;
            } else {
                inputHtml = `<input type="text" class="form-control" value="${block.content}" oninput="updateBlockValue(${stepIndex}, ${blockIndex}, 'content', this.value)">`;
            }

            el.innerHTML = `
                <div class="block-label">
                    <span>${COMPONENTS[block.type].icon} ${COMPONENTS[block.type].label}</span>
                </div>
                <button class="block-delete" onclick="removeBlock(${stepIndex}, ${blockIndex})">&times;</button>
                ${inputHtml}
            `;
            container.appendChild(el);
        }

        // --- 4. çŠ¶æ€æ›´æ–°æ“ä½œ ---
        function addStep() {
            state.steps.push({ id: Date.now(), blocks: [{ type: 'text', content: '' }] });
            renderStepsEditor();
            renderPreview();
        }

        function removeStep(index) {
            if(confirm('ç¡®å®šåˆ é™¤è¯¥æ­¥éª¤å—ï¼Ÿ')) {
                state.steps.splice(index, 1);
                renderStepsEditor();
                renderPreview();
            }
        }

        function addBlock(stepIndex, type) {
            const defaultContent = COMPONENTS[type].default;
            // ç®€å•æ·±æ‹·è´é»˜è®¤å€¼
            const content = typeof defaultContent === 'object' ? {...defaultContent} : defaultContent;
            state.steps[stepIndex].blocks.push({ type, ... (typeof content === 'object' ? content : {content}) });
            renderStepsEditor();
            renderPreview();
        }

        function removeBlock(stepIndex, blockIndex) {
            state.steps[stepIndex].blocks.splice(blockIndex, 1);
            renderStepsEditor(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç´¢å¼•
            renderPreview();
        }

        function updateBlockValue(stepIdx, blockIdx, key, value) {
            if (state.steps[stepIdx].blocks[blockIdx].type === 'image') {
                state.steps[stepIdx].blocks[blockIdx][key] = value;
            } else {
                state.steps[stepIdx].blocks[blockIdx].content = value;
            }
            // å¢åŠ é˜²æŠ–å¯ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œè¿™é‡Œç›´æ¥å®æ—¶æ¸²æŸ“
            renderPreview();
        }

        // ç®€æ˜“çš„çŠ¶æ€åŒæ­¥ (ç”¨äºæ‹–æ‹½å)
        function updateStateFromDOM() {
            // åœ¨è¿™ä¸ªç®€å•ç‰ˆæœ¬ä¸­ï¼Œæ‹–æ‹½ç”±äºä¿®æ”¹äº† DOM ç»“æ„ä½†æ²¡ä¿®æ”¹ state æ•°ç»„
            // å¤æ‚çš„æ‹–æ‹½é€»è¾‘é€šå¸¸éœ€è¦æ ¹æ® evt.oldIndex å’Œ evt.newIndex æ“ä½œæ•°ç»„
            // è¿™é‡Œä¸ºäº†ä»£ç ç®€æ´ï¼Œå»ºè®®æ‹–æ‹½ä»…ç”¨äºæ¼”ç¤ºï¼Œæˆ–æ·»åŠ æ›´å¤æ‚çš„é€»è¾‘
            // å®é™…ä¸Šï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå»ºè®®é‡æ–°æŒ‰å½“å‰ UI é¡ºåºæ„å»º state
            // (ç•¥ï¼šå®ç°å®Œæ•´çš„ DOM -> State æ˜ å°„ä¼šå¢åŠ å¾ˆå¤šä»£ç é‡)
        }

        // --- 5. æ ¸å¿ƒé€»è¾‘ï¼šæ¸²æŸ“é¢„è§ˆå¡ç‰‡ ---
        function renderPreview() {
            const root = document.getElementById('cardRoot');
            
            // è®¾ç½® CSS å˜é‡
            root.style.setProperty('--accent', state.themeColor);
            
            // æ„å»º HTML
            let stepsHtml = state.steps.map((step, idx) => {
                const blocksHtml = step.blocks.map(block => renderBlockHtml(block)).join('');
                return `
                    <div class="step-row">
                        <div class="step-idx">${idx + 1}</div>
                        <div class="step-content">
                            ${blocksHtml}
                        </div>
                    </div>
                `;
            }).join('');

            const warningHtml = state.warning ? `
                <div class="card-foot">
                    <div class="foot-head"><i>ğŸ“Œ</i> é‡ç‚¹æé†’</div>
                    <div class="foot-content">${state.warning}</div>
                </div>
            ` : '';

            root.innerHTML = `
                <div class="card-head">
                    <div class="head-num">${state.header.num}</div>
                    <div class="head-text">
                        <span class="head-en">${state.header.en}</span>
                        <div class="head-title">${state.header.title}</div>
                    </div>
                    <div class="deco-circle"></div>
                </div>
                <div class="card-body">
                    <div class="timeline-line"></div>
                    ${stepsHtml}
                </div>
                ${warningHtml}
            `;
        }

        function renderBlockHtml(block) {
            const content = block.content || '';
            switch(block.type) {
                case 'text':
                    return `<div class="comp-text">${content.replace(/\n/g, '<br>')}</div>`;
                case 'prompt':
                    return `<div class="comp-prompt">${content}</div>`;
                case 'image':
                    const imgUrl = block.url || 'https://via.placeholder.com/600x300?text=No+Image';
                    return `
                        <div class="comp-image">
                            <img src="${imgUrl}" alt="image">
                            ${block.caption ? `<div class="comp-image-caption">${block.caption}</div>` : ''}
                        </div>`;
                case 'option':
                    return `<div class="comp-option"><span style="font-size:18px">ğŸ”˜</span> ${content}</div>`;
                case 'success':
                    return `<div class="comp-alert success"><span class="icon">âœ…</span><div>${content}</div></div>`;
                case 'tip':
                    return `<div class="comp-alert tip"><span class="icon">ğŸ’¡</span><div>${content}</div></div>`;
                case 'warning':
                    return `<div class="comp-alert warning"><span class="icon">âš ï¸</span><div>${content}</div></div>`;
                default:
                    return `<div>${content}</div>`;
            }
        }

        // --- 6. å¯¼å‡ºåŠŸèƒ½ ---
        function exportImage() {
            const overlay = document.getElementById('exportOverlay');
            overlay.style.display = 'flex';
            
            const element = document.getElementById('captureTarget');
            // ä¸´æ—¶ç§»é™¤ç¼©æ”¾ transform ä»¥ä¾¿å…¨å°ºå¯¸æˆªå›¾
            // (æ­¤å¤„æœªåŠ ç¼©æ”¾é€»è¾‘ï¼Œå¦‚æœåŠ äº† scale éœ€è¦é‡ç½®)
            
            html2canvas(document.getElementById('cardRoot'), {
                scale: 2, // é«˜æ¸…
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `å°çº¢ä¹¦å¡ç‰‡_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                overlay.style.display = 'none';
            }).catch(err => {
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å…è®¸è·¨åŸŸ');
                console.error(err);
                overlay.style.display = 'none';
            });
        }

        function exportHtml() {
            const htmlContent = document.getElementById('cardRoot').outerHTML;
            const cssContent = document.querySelector('style').innerHTML;
            
            const fullHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>${cssContent} body { display:flex; justify-content:center; padding:20px; background:#f0f0f0; } .xhs-card { box-shadow: 0 5px 20px rgba(0,0,0,0.1); }</style>
</head>
<body>
    ${htmlContent}
</body>
</html>`;
            
            const blob = new Blob([fullHtml], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'card-export.html';
            a.click();
        }

        // è¾…åŠ©å‡½æ•°ï¼šrgbè½¬hex
        function rgbToHex(rgb) {
            if(!rgb) return '';
            const [r, g, b] = rgb.match(/\d+/g);
            return "#" + ((1 << 24) + (+r << 16) + (+g << 8) + +b).toString(16).slice(1);
        }
    </script>
</body>
</html>