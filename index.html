<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦ä½œå›¾å…¨èƒ½å¡ç‰‡å·¥å‚ V10</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #2A00FF;
            --primary-light: rgba(42, 0, 255, 0.1);
            --bg-light: #F2F4F8;
            --border: #E0E0E0;
            --text-main: #333;
            --card-w: 600px;
            --card-h: 800px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-light);
            font-family: 'PingFang SC', sans-serif;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* æ¨å¹¿å¼•æµä¿¡æ¯å›ºå®šå¤´éƒ¨ */
        .marketing-header {
            padding: 10px 40px;
            background: #f7f7f7;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            height: 40px;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .marketing-header strong {
            color: var(--primary);
            font-weight: 700;
        }

        /* äºŒç»´ç æ‚¬åœå®¹å™¨å’Œæ ·å¼ (ä¼˜åŒ– 3) */
        .marketing-header .marketing-item {
            position: relative;
            display: flex;
            align-items: center;
            cursor: default;
        }

        .marketing-header .qr-code-box {
            position: absolute;
            top: 100%;
            /* ä½ç½®åœ¨æ–‡æœ¬ä¸‹æ–¹ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            display: none;
            /* é»˜è®¤éšè— */
            pointer-events: none;
            margin-top: 5px;
            white-space: nowrap;
            /* é˜²æ­¢å†…å®¹æŠ˜è¡Œ */
        }

        .marketing-header .qr-code-box img {
            width: 120px;
            height: 120px;
            display: block;
        }

        .marketing-header .marketing-item:hover .qr-code-box {
            display: block;
        }


        /* å¸ƒå±€æ¡†æ¶ (ä¼˜åŒ– 1: flex: 1 ç¡®ä¿å¡«å……å‰©ä½™é«˜åº¦) */
        .app-container {
            display: flex;
            flex: 1;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
            height: 0;
        }

        /* å·¦ä¾§é…ç½®æ  */
        .config-panel {
            width: 460px;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tab-group {
            display: flex;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tab-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 8px 4px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            transition: 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
        }

        /* è¡¨å•ç»„ä»¶ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 700;
            color: #555;
            margin-bottom: 8px;
            display: block;
        }

        /* Textarea å¢é«˜ */
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: 0.2s;
            min-height: 45px;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* é¢œè‰²é€‰æ‹© */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .color-dot {
            padding-bottom: 100%;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-dot.active {
            transform: scale(1.1);
            border-color: #333;
        }

        /* è¡¨æƒ…é€‰æ‹©å™¨ */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .emoji-btn {
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .emoji-btn:hover {
            background: #eee;
        }

        /* æ¨¡æ¿é€‰æ‹©å¡ç‰‡ */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .template-card {
            border: 2px solid #eee;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
        }

        .template-card.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        .template-preview-box {
            height: 40px;
            background: #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area {
            flex: 1;
            background: #E1E4E8;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: hidden;
        }

        /* æ ¸å¿ƒå®šä½ */
        .canvas-wrapper {
            position: relative;
            width: var(--card-w);
            height: var(--card-h);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            transform-origin: center center;
        }

        /* ç”»å¸ƒé€šç”¨ */
        .xhs-canvas {
            width: var(--card-w);
            height: var(--card-h);
            background: #fff;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            display: none;
        }

        .xhs-canvas.active {
            display: flex;
        }

        /* å›¾ç‰‡åˆ¶ä½œç”»å¸ƒæ ·å¼ (ä¼˜åŒ– 2) */
        .image-canvas {
            flex-direction: column;
            background: #fff;
            padding: 40px;
            justify-content: space-between;
            /* ç¡®ä¿ footer åˆ°åº•éƒ¨ */
        }

        .image-title {
            font-size: 32px;
            font-weight: 900;
            color: var(--primary);
            line-height: 1.3;
            margin-bottom: 20px;
            border-bottom: 3px solid #eee;
            padding-bottom: 15px;
        }

        .image-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
            margin-bottom: 20px;
        }

        /* ç»„ä»¶æ ·å¼ - ç»§æ‰¿è‡ªæ•™ç¨‹é¡µï¼Œä½†åœ¨å›¾ç‰‡é¡µå¼ºåŒ– */
        .image-canvas .comp-option {
            margin-bottom: 15px;
        }

        .image-canvas .comp-option .option-bullet {
            background: var(--primary);
            /* ä½¿ç”¨ä¸»é¢˜è‰² */
            width: 20px;
            height: 20px;
            font-size: 12px;
            margin-top: 4px;
        }

        .image-canvas .comp-option .option-text {
            font-size: 18px !important;
            font-weight: 600;
            color: #333;
        }

        /* é€šç”¨ Textarea æ ·å¼ */
        .cover-canvas .cover-title,
        .cover-canvas .cover-subtitle,
        .cover-canvas .cover-body {
            white-space: pre-wrap;
        }

        /* æ­¥éª¤ç¼–è¾‘å™¨æ ·å¼ */
        .block-item textarea.form-control {
            padding: 5px;
            font-size: 12px;
            height: auto;
            min-height: 40px;
            /* æå‡æœ€å°é«˜åº¦ */
            overflow-y: hidden;
            resize: none;
            flex-grow: 1;
        }

        /* [çœç•¥å…¶ä»–æœªä¿®æ”¹çš„ç”»å¸ƒæ ·å¼ï¼Œå¦‚ tpl-thinking, tutorial-canvas ç­‰] */
        /* === å°é¢è®¾è®¡æ ·å¼ === */
        .cover-canvas {
            flex-direction: column;
            color: #fff;
        }

        .tpl-thinking {
            background: var(--primary);
            align-items: center;
            padding: 60px;
            text-align: center;
        }

        .tpl-thinking .cover-icon {
            font-size: 120px;
            margin-bottom: 30px;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.2));
        }

        .tpl-thinking .cover-title {
            font-size: 72px;
            font-weight: 900;
            line-height: 1.2;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tpl-thinking .cover-subtitle {
            background: #fff;
            color: var(--primary);
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 28px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tpl-tutorial {
            background: #f5f5f7;
            padding: 40px;
            justify-content: flex-start;
        }

        .tpl-tutorial::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 35%;
            background: var(--primary);
            z-index: 0;
        }

        .tpl-tutorial .tutorial-card {
            background: #fff;
            border-radius: 20px;
            flex: 1;
            z-index: 1;
            margin-top: 60px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        .tpl-tutorial .cover-tag {
            position: absolute;
            top: -25px;
            background: #000;
            color: #fff;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
        }

        .tpl-tutorial .cover-title {
            color: #333;
            font-size: 64px;
            font-weight: 900;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .tpl-tutorial .cover-title span {
            color: var(--primary);
        }

        .tpl-tutorial .cover-subtitle {
            font-size: 24px;
            color: #666;
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 20px;
            width: 100%;
        }

        .tpl-emotion {
            background: linear-gradient(135deg, #111, #333);
            color: #fff;
            padding: 40px;
            flex-direction: column;
        }

        .tpl-emotion .cover-title {
            font-size: 80px;
            font-weight: 900;
            line-height: 1.1;
            margin-top: auto;
            margin-bottom: 40px;
        }

        .tpl-contrast {
            background: #fff;
            color: #333;
            padding: 40px;
            flex-direction: column;
            justify-content: flex-start;
        }

        .tpl-contrast .cover-title {
            font-size: 40px;
            font-weight: 900;
            color: var(--primary);
            line-height: 1.3;
            text-align: center;
            margin-bottom: 40px;
        }

        .tpl-contrast-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding-bottom: 40px;
        }

        .contrast-col-label {
            font-size: 20px;
            font-weight: 800;
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .contrast-col-right .contrast-col-label {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .contrast-col-body {
            font-size: 18px;
            line-height: 1.8;
            color: #444;
            white-space: pre-wrap;
        }

        /* æ•™ç¨‹ç”»å¸ƒæ ·å¼ - ä¿æŒä¸å˜ */
        .tutorial-canvas {
            flex-direction: column;
            background: #fff;
        }

        .step-header {
            padding: 30px 40px 15px;
            border-bottom: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .step-num {
            font-size: 72px;
            font-weight: 900;
            color: var(--primary);
            font-style: italic;
            line-height: 0.8;
        }

        .step-header-text {
            text-align: right;
        }

        .step-header-en {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            color: #000;
            letter-spacing: 1px;
        }

        .step-header-title {
            font-size: 24px;
            font-weight: 800;
            color: #000;
            margin-top: 4px;
        }

        .step-body {
            padding: 30px 40px;
            flex: 1;
            overflow-y: auto;
        }

        .step-item {
            display: flex;
            margin-bottom: 35px;
            position: relative;
            align-items: stretch;
        }

        .step-left {
            width: 30px;
            margin-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .step-idx {
            width: 30px;
            height: 30px;
            background: var(--primary);
            color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
            z-index: 1;
        }

        .step-line-segment {
            flex-grow: 1;
            width: 2px;
            background: #eee;
            margin-top: 5px;
            margin-bottom: -5px;
        }

        .step-item:last-child .step-line-segment {
            display: none;
        }

        .step-right {
            flex: 1;
        }

        .step-right div[style*="font-size:17px"] {
            font-size: 17px !important;
            line-height: 1.6;
        }

        /* ç»„ä»¶æ ·å¼ */
        .comp-prompt {
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 12px;
            font-family: monospace;
            font-size: 14px;
            color: #444;
            margin-top: 6px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .comp-img {
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 6px;
        }

        .comp-img img {
            width: 100%;
            display: block;
        }

        .comp-option {
            display: flex;
            align-items: flex-start;
            margin-top: 10px;
        }

        .comp-option .option-bullet {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2px;
            margin-right: 10px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .comp-option .option-text {
            font-size: 17px;
            line-height: 1.6;
        }

        .comp-status-box {
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 6px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .comp-tip {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .comp-success {
            background: rgba(0, 196, 140, 0.1);
            border: 1px solid #00C48C;
            color: #00C48C;
        }

        .comp-warning {
            background: rgba(255, 125, 0, 0.1);
            border: 1px solid #FF7D00;
            color: #FF7D00;
        }

        /* æ ‡ç­¾ */
        .comp-tag {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }


        /* å¯¼å‡ºé®ç½© */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æ­¥éª¤ç¼–è¾‘å™¨æ ·å¼ */
        .step-edit-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .step-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: bold;
            color: #666;
            cursor: move;
        }

        .block-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .block-item {
            display: flex;
            gap: 5px;
            align-items: flex-start;
        }

        .block-item span {
            font-size: 12px;
            color: #999;
            width: 60px;
            cursor: move;
            flex-shrink: 0;
            margin-top: 5px;
        }

        .block-btn-bar {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tiny-btn {
            font-size: 11px;
            padding: 3px 8px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .tiny-btn:hover {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        /* ä¸»æ–‡æ¡ˆæ ·å¼ */
.marketing-main {
    display: inline-block;
    margin-right: 12px;
    font-weight: 500;
    color: #333;
}
/* æ¯ä¸ªè”ç³»é¡¹æ ·å¼ */
.marketing-item {
    display: inline-block;
    margin: 0 10px;
    position: relative; /* é…åˆäºŒç»´ç å¼¹çª—å®šä½ */
}
/* æç¤ºæ–‡å­—æ ·å¼ */
.marketing-tip {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
}
/* äºŒç»´ç ç›’å­æ ·å¼ï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰ */
.qr-code-box {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 8px;
    padding: 8px;
    background: #fff;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
    z-index: 999;
}
/* æ‚¬åœæ˜¾ç¤ºäºŒç»´ç  */
.marketing-item:hover .qr-code-box {
    display: block;
}
/* äºŒç»´ç å›¾ç‰‡æ ·å¼ */
.qr-code-box img {
    width: 160px;
    height: 160px;
    object-fit: cover;
}
    </style>
</head>

<body>
    <div class="marketing-header" id="marketingHeader">
    </div>

    <input type="file" id="localImageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">

    <div class="app-container">
        <div class="config-panel">
            <div class="panel-header">
                <h2 style="font-size:18px;">ğŸ¨ å°çº¢ä¹¦ä½œå›¾å…¨èƒ½å·¥å‚ V10</h2>

                <!-- <div class="form-group" style="margin-bottom: 15px; margin-top: 15px;">
                <label class="form-label" style="margin-bottom: 5px;">å¼•æµä¿¡æ¯è®¾ç½® (æ˜¾ç¤ºåœ¨é¡µé¢é¡¶éƒ¨)</label>
                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <input type="text" class="form-control" id="wechatId" placeholder="å…¬ä¼—å· ID" value="å…¬ä¼—å·ID" style="padding: 6px; min-height: 38px;">
                    <input type="text" class="form-control" id="xhsId" placeholder="å°çº¢ä¹¦ ID" value="å°çº¢ä¹¦ID" style="padding: 6px; min-height: 38px;">
                </div>
                <label class="form-label" style="font-size: 11px; font-weight: normal; margin-bottom: 5px; color:#888;">äºŒç»´ç å›¾ç‰‡URL (é¼ æ ‡æ‚¬åœæ˜¾ç¤º)</label>
                 <div style="display:flex; gap:10px;">
                    <input type="text" class="form-control" id="wechatQr" placeholder="å…¬ä¼—å·äºŒç»´ç  URL" value="https://i.ibb.co/L5hY67g/wechat-qr-placeholder.png" style="padding: 6px; min-height: 38px;">
                    <input type="text" class="form-control" id="xhsQr" placeholder="å°çº¢ä¹¦äºŒç»´ç  URL" value="https://i.ibb.co/hK7J01d/xhs-qr-placeholder.png" style="padding: 6px; min-height: 38px;">
                </div>
            </div> -->

                <div class="tab-group" id="tabGroup">
                    <button class="tab-btn active" onclick="switchTab('cover', this)">å°é¢è®¾è®¡</button>
                    <button class="tab-btn" onclick="switchTab('tutorial', this)">æ•™ç¨‹æ­¥éª¤</button>
                    <button class="tab-btn" onclick="switchTab('image', this)">å›¾ç‰‡åˆ¶ä½œ</button>
                </div>
            </div>

            <div class="panel-body">
                <div class="form-group">
                    <label class="form-label">ä¸»é¢˜é…è‰² (æ”¯æŒè‡ªå®šä¹‰)</label>
                    <div class="color-grid" id="themeColors"></div>
                    <div style="display:flex; gap:10px; margin-top:15px; align-items:center;">
                        <input type="color" id="customColorPicker" value="#2A00FF"
                            style="width:40px; height:40px; padding:0; border:none; cursor:pointer;">
                        <input type="text" class="form-control" id="customColorHex" value="#2A00FF"
                            placeholder="è¾“å…¥ Hex é¢œè‰²ä»£ç " style="flex:1; min-height: 38px;">
                    </div>
                </div>

                <div id="config-cover" class="config-section active">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©æ¨¡æ¿</label>
                        <div class="template-grid">
                            <div class="template-card" onclick="setCoverTemplate('thinking')">
                                <div class="template-preview-box" style="background:var(--primary)"></div>
                                æ€è€ƒä¸“ä¸š
                            </div>
                            <div class="template-card" onclick="setCoverTemplate('tutorial')">
                                <div class="template-preview-box" style="background:#eee; border:1px solid #ccc"></div>
                                å¡ç‰‡æ•™ç¨‹
                            </div>
                            <div class="template-card" onclick="setCoverTemplate('emotion')">
                                <div class="template-preview-box" style="background:linear-gradient(45deg,#111,#333)">
                                </div>
                                æƒ…ç»ªå¤§å­—
                            </div>
                            <div class="template-card" onclick="setCoverTemplate('contrast')">
                                <div class="template-preview-box"
                                    style="background:linear-gradient(90deg, #f9f9f9 50%, var(--primary-light) 50%); border:1px solid #ccc">
                                </div>
                                å¯¹æ¯”åˆ†æ
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å°é¢ä¸»æ ‡é¢˜</label>
                        <textarea class="form-control mb-2" id="coverTitle" placeholder="ä¸»æ ‡é¢˜ (å¦‚: 3åˆ†é’Ÿå­¦ä¼š)"
                            rows="3">DeepSeek</textarea>
                    </div>

                    <div class="form-group" id="coverSubtitleGroup">
                        <label class="form-label">å°é¢å‰¯æ ‡é¢˜ / é«˜äº®</label>
                        <textarea class="form-control mb-2" id="coverSubtitle" placeholder="å‰¯æ ‡é¢˜/é«˜äº® (å¦‚: é™„ä¿å§†çº§æ•™ç¨‹)"
                            rows="3">ç”Ÿæˆä¸“å±æç¤ºè¯</textarea>
                    </div>

                    <div id="coverContrastGroup" style="display:none;">
                        <label class="form-label">å¯¹æ¯”æ ‡ç­¾ & å†…å®¹</label>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" class="form-control" id="coverLeftLabel" value="é”™è¯¯åšæ³•" placeholder="å·¦ä¾§æ ‡ç­¾"
                                style="flex:1; padding: 6px; min-height: 38px;">
                            <input type="text" class="form-control" id="coverRightLabel" value="æ­£ç¡®åšæ³•" placeholder="å³ä¾§æ ‡ç­¾"
                                style="flex:1; padding: 6px; min-height: 38px;">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <textarea class="form-control" id="coverSubtitleLeft" placeholder="å·¦ä¾§å†…å®¹ (å¤šè¡Œ)" rows="5"
                                style="flex:1;">å†…å®¹ 1\nå†…å®¹ 2\nå†…å®¹ 3</textarea>
                            <textarea class="form-control" id="coverSubtitleRight" placeholder="å³ä¾§å†…å®¹ (å¤šè¡Œ)" rows="5"
                                style="flex:1;">å†…å®¹ A\nå†…å®¹ B\nå†…å®¹ C</textarea>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="form-label">å‚ç›´ä½ç½® (ä»…æ€è€ƒ/æƒ…ç»ªæ¨¡æ¿)</label>
                        <select class="form-control" id="coverAlign" onchange="updateCoverAlign(this.value)">
                            <option value="center">å±…ä¸­ (é»˜è®¤)</option>
                            <option value="flex-start">é¡¶éƒ¨</option>
                            <option value="flex-end">åº•éƒ¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è£…é¥°å›¾æ ‡ (Emoji)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" class="form-control" id="coverIcon" value="ğŸ¤–"
                                style="width:60px; text-align:center; font-size:20px; min-height: 38px;">
                            <div style="flex:1; font-size:12px; color:#999; display:flex; align-items:center;">ç‚¹å‡»ä¸‹æ–¹å¿«é€Ÿé€‰æ‹©
                                ğŸ‘‡</div>
                        </div>
                        <div class="emoji-grid" id="emojiPicker">
                        </div>
                    </div>
                </div>

                <div id="config-tutorial" class="config-section">
                    <div class="form-group">
                        <label class="form-label">é¡µçœ‰è®¾ç½®</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" class="form-control" id="stepNum" value="01"
                                style="width:60px; min-height: 38px;">
                            <input type="text" class="form-control" id="stepTitle" value="ç”Ÿæˆä¸“å±æç¤ºè¯"
                                style="min-height: 38px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label class="form-label">æ­¥éª¤å†…å®¹</label>
                            <button class="tiny-btn" style="background:var(--primary); color:#fff; border:none;"
                                onclick="addStep('tutorial')">+ åŠ æ­¥éª¤</button>
                        </div>
                        <div id="tutorialStepsContainer">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">åº•éƒ¨æé†’</label>
                        <textarea class="form-control" id="tutorialFooterText" rows="3">ğŸ“Œ å»ºè®®æ”¶è—ï¼Œéšæ—¶æŸ¥é˜…</textarea>
                    </div>
                </div>

                <div id="config-image" class="config-section">
                    <div class="form-group">
                        <label class="form-label">å¡ç‰‡ä¸»æ ‡é¢˜</label>
                        <textarea class="form-control" id="imageTitle" rows="3" placeholder="å¦‚ï¼š5ä¸ªæŠ€å·§å¸®ä½ è§£å†³ç„¦è™‘"></textarea>
                    </div>

                    <div class="form-group">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label class="form-label">å†…å®¹åŒºå— (æ— æ­¥éª¤)</label>
                            <button class="tiny-btn" style="background:var(--primary); color:#fff; border:none;"
                                onclick="addStep('image')">+ åŠ åŒºå—</button>
                        </div>
                        <div id="imageBlocksContainer">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¡ç‰‡åº•éƒ¨æ–‡å­—</label>
                        <textarea class="form-control" id="imageFooterText" rows="3">ğŸ‰ å¿«é€Ÿè¡ŒåŠ¨ï¼Œæ‹’ç»ç„¦è™‘</textarea>
                    </div>
                </div>


            </div>

            <div style="padding:20px; border-top:1px solid #eee; display:flex; gap:10px; flex-shrink: 0;">
                <button class="form-control"
                    style="background:var(--primary); color:#fff; font-weight:bold; border:none; min-height: 40px;"
                    onclick="exportImage()">ğŸ“¸ å¯¼å‡ºå½“å‰å›¾ç‰‡</button>
            </div>
        </div>

        <div class="preview-area">
            <div class="canvas-wrapper">
                <div id="canvas-cover" class="xhs-canvas cover-canvas tpl-thinking active">
                </div>

                <div id="canvas-tutorial" class="xhs-canvas tutorial-canvas">
                </div>

                <div id="canvas-image" class="xhs-canvas image-canvas">
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨ç”Ÿæˆé«˜æ¸…å¤§å›¾...</p>
    </div>

    <script>
        // === æ•°æ®çŠ¶æ€ ===
        const state = {
            theme: '#2A00FF',
            tab: 'cover', // cover | tutorial | image

            // æ¨å¹¿ä¿¡æ¯ (ä¼˜åŒ– 3: å¢åŠ äºŒç»´ç  URL)
            marketing: {
                wechat: 'é˜¿é£AIå·¥å…·',
                xhs: 'é˜¿é£AIå·¥å…·',
                wechatQr: 'http://afei-image.test.upcdn.net/qrcode_for_gh_cffc65e8a22b_344.jpg', // å…¬ä¼—å·äºŒç»´ç å ä½å›¾
                xhsQr: 'http://afei-image.test.upcdn.net/xiaohongshu1.jpg'     // å°çº¢ä¹¦äºŒç»´ç å ä½å›¾
            },

            cover: {
                template: 'thinking',
                title: 'DeepSeek',
                subtitle: 'ç”Ÿæˆä¸“å±æç¤ºè¯',
                icon: 'ğŸ¤–',
                align: 'center',
                subtitleLeft: 'å†…å®¹ 1\nå†…å®¹ 2\nå†…å®¹ 3',
                subtitleRight: 'å†…å®¹ A\nå†…å®¹ B\nå†…å®¹ C',
                leftLabel: 'é”™è¯¯åšæ³•',
                rightLabel: 'æ­£ç¡®åšæ³•'
            },

            tutorial: {
                num: '01',
                en: 'STEP ONE',
                title: 'ç”Ÿæˆä¸“å±æç¤ºè¯',
                steps: [
                    {
                        id: 1, blocks: [
                            { type: 'text', val: 'æ‰“å¼€ <span class="comp-tag">DeepSeek</span> å®˜ç½‘' },
                            { type: 'image', val: 'https://picsum.photos/500/250' }
                        ]
                    },
                ],
                footer: 'ğŸ“Œ å»ºè®®æ”¶è—ï¼Œéšæ—¶æŸ¥é˜…'
            },

            image: {
                title: '5ä¸ªæŠ€å·§å¸®ä½ è§£å†³ç„¦è™‘',
                blocks: [
                    {
                        id: 1, blocks: [
                            { type: 'option', val: '1. å°è¯• 10 åˆ†é’Ÿå†¥æƒ³' },
                            { type: 'option', val: '2. ä¿è¯ 7 å°æ—¶æ·±åº¦ç¡çœ ' },
                            { type: 'option', val: '3. åšæŒæ¯å‘¨ 3 æ¬¡é”»ç‚¼' },
                            { type: 'tip', val: 'ğŸ’¡ è´´å£«ï¼šè¡ŒåŠ¨èµ·æ¥æ˜¯è§£å†³ç„¦è™‘çš„æœ€ä½³æ–¹æ³•ã€‚' }
                        ]
                    },
                ],
                footer: 'ğŸ‰ å¿«é€Ÿè¡ŒåŠ¨ï¼Œæ‹’ç»ç„¦è™‘'
            }
        };

        const EMOJIS = ['ğŸ¤–', 'âœ¨', 'ğŸ”¥', 'ğŸ’¡', 'ğŸ“š', 'ğŸ¨', 'âœ…', 'âš ï¸', 'ğŸŒŸ', 'ğŸ’¬', 'ğŸ“…', 'ğŸš€', 'ğŸ’»', 'ğŸ“±', 'ğŸ“', 'ğŸ’¼'];
        const COLORS = ['#2A00FF', '#FF2442', '#00C48C', '#FF7D00', '#7B61FF', '#222222'];

        const BLOCK_TYPE_LABELS = {
            'text': 'ğŸ“ æ–‡æœ¬',
            'prompt': 'ğŸ’» æç¤ºè¯',
            'image': 'ğŸ–¼ï¸ å›¾ç‰‡',
            'option': 'ğŸ”˜ é€‰é¡¹',
            'tip': 'ğŸ’¡ è´´å£«',
            'success': 'âœ… æˆåŠŸ',
            'warning': 'âš ï¸ è­¦å‘Š'
        };

        let currentStepIdxForUpload = -1;
        let currentTabForUpload = '';

        // === å·¥å…·å‡½æ•°ï¼šé˜²æŠ–åŠ¨ ===
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–é¢œè‰²å’Œè¡¨æƒ…
            initColors();
            initEmojis();

            // åˆå§‹åŒ–è¾“å…¥æ¡†å†…å®¹å’Œé«˜åº¦
            document.getElementById('coverTitle').value = state.cover.title;
            document.getElementById('coverSubtitle').value = state.cover.subtitle;
            document.getElementById('coverSubtitleLeft').value = state.cover.subtitleLeft;
            document.getElementById('coverSubtitleRight').value = state.cover.subtitleRight;
            document.getElementById('imageTitle').value = state.image.title;
            document.getElementById('tutorialFooterText').value = state.tutorial.footer;
            document.getElementById('imageFooterText').value = state.image.footer;

            // æ¨å¹¿ä¿¡æ¯è¾“å…¥æ¡†
            // document.getElementById('wechatId').value = state.marketing.wechat;
            // document.getElementById('xhsId').value = state.marketing.xhs;
            // document.getElementById('wechatQr').value = state.marketing.wechatQr; // ç»‘å®šäºŒç»´ç URL
            // document.getElementById('xhsQr').value = state.marketing.xhsQr;     // ç»‘å®šäºŒç»´ç URL

            document.querySelectorAll('textarea').forEach(autoResizeTextarea);


            renderEditors();

            // ç¡®ä¿åœ¨ renderAll ä¹‹å‰è°ƒç”¨ setCoverTemplateï¼Œä»¥è®¾ç½®æ­£ç¡®çš„æ¨¡æ¿ active çŠ¶æ€
            setCoverTemplate(state.cover.template);
            renderAll();

            // ç»‘å®šè¾“å…¥ç›‘å¬
            bindTextarea('coverTitle', (v) => { state.cover.title = v; renderCover(); });
            bindTextarea('coverSubtitle', (v) => { state.cover.subtitle = v; renderCover(); });
            bindTextarea('coverSubtitleLeft', (v) => { state.cover.subtitleLeft = v; renderCover(); });
            bindTextarea('coverSubtitleRight', (v) => { state.cover.subtitleRight = v; renderCover(); });
            bindInput('coverLeftLabel', (v) => { state.cover.leftLabel = v; renderCover(); });
            bindInput('coverRightLabel', (v) => { state.cover.rightLabel = v; renderCover(); });
            bindInput('coverIcon', (v) => { state.cover.icon = v; renderCover(); });

            bindInput('stepNum', (v) => { state.tutorial.num = v; state.tutorial.en = convertNumToEnglish(v); renderTutorial(); });
            bindInput('stepTitle', (v) => { state.tutorial.title = v; renderTutorial(); });
            bindTextarea('tutorialFooterText', (v) => { state.tutorial.footer = v; renderTutorial(); });

            bindTextarea('imageTitle', (v) => { state.image.title = v; renderImage(); });
            bindTextarea('imageFooterText', (v) => { state.image.footer = v; renderImage(); });

            // æ¨å¹¿ä¿¡æ¯ (ç»‘å®šæ—¶æ›´æ–°é¡µé¢é¡¶éƒ¨æ˜¾ç¤º)
            // bindInput('wechatId', (v) => { state.marketing.wechat = v; renderMarketingHeader(); });
            // bindInput('xhsId', (v) => { state.marketing.xhs = v; renderMarketingHeader(); });
            // bindInput('wechatQr', (v) => { state.marketing.wechatQr = v; renderMarketingHeader(); }); // ç»‘å®šäºŒç»´ç  URL
            // bindInput('xhsQr', (v) => { state.marketing.xhsQr = v; renderMarketingHeader(); });     // ç»‘å®šäºŒç»´ç  URL


            // æ‹–æ‹½åˆå§‹åŒ–
            new Sortable(document.getElementById('tutorialStepsContainer'), { handle: '.step-top', animation: 150, onEnd: () => { updateStateFromDom('tutorial'); } });
            new Sortable(document.getElementById('imageBlocksContainer'), { handle: '.step-top', animation: 150, onEnd: () => { updateStateFromDom('image'); } });

            renderMarketingHeader(); // é¦–æ¬¡æ¸²æŸ“æ¨å¹¿ä¿¡æ¯æ 
        });

        // === æ ¸å¿ƒå·¥å…·å‡½æ•° ===

        function autoResizeTextarea(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function bindTextarea(id, callback) {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                autoResizeTextarea(e.target);
                callback(e.target.value);
            });
            autoResizeTextarea(el);
        }

        function bindInput(id, callback) {
            document.getElementById(id).addEventListener('input', (e) => callback(e.target.value));
        }

        // === æ¨å¹¿ä¿¡æ¯æ¸²æŸ“ (æ›´æ–°ä¸ºæ”¯æŒäºŒç»´ç ) ===
        function renderMarketingHeader() {
            const el = document.getElementById('marketingHeader');
            if (!el) return;

            // é…ç½®æ–‡æ¡ˆå¸¸é‡ï¼Œä¾¿äºåç»­ç»Ÿä¸€ä¿®æ”¹
            const config = {
                mainText: 'æœ‰é—®é¢˜ï¼Ÿæ‰«ç /ç§ä¿¡æ‰¾æˆ‘ï¼',
                wechatTip: 'é¼ æ ‡æ‚¬åœæ˜¾ç¤ºäºŒç»´ç ',
                xhsTip: 'æ‚¬åœæ‰«ç /ç§ä¿¡ç­”ç–‘',
                wechatLabel: 'å…¬ä¼—å·',
                xhsLabel: 'å°çº¢ä¹¦'
            };

            const wechatHtml = state.marketing.wechat
                ? `<span class="marketing-item">
            <span class="marketing-label">${config.wechatLabel}: <strong>${state.marketing.wechat}</strong></span>
            <span class="marketing-tip">${config.wechatTip}</span>
            <div class="qr-code-box"><img src="${state.marketing.wechatQr}" alt="${state.marketing.wechat}äºŒç»´ç "></div>
           </span>`
                : '';

            const xhsHtml = state.marketing.xhs
                ? `<span class="marketing-item">
            <span class="marketing-label"><i class="xhs-icon">ğŸ“•</i>${config.xhsLabel}: <strong>${state.marketing.xhs}</strong></span>
            <span class="marketing-tip">${config.xhsTip}</span>
            <div class="qr-code-box"><img src="${state.marketing.xhsQr}" alt="${state.marketing.xhs}äºŒç»´ç "></div>
           </span>`
                : '';

            el.innerHTML = `<span class="marketing-main">${config.mainText}</span>` + wechatHtml + xhsHtml;
        }

        // === æ ¸å¿ƒé€»è¾‘ï¼šåˆ‡æ¢ Tab å’Œä¸»é¢˜è‰² ===
        function switchTab(tab, btn) {
            state.tab = tab;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active'); // ç¡®ä¿ btn å­˜åœ¨

            document.querySelectorAll('.config-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`config-${tab}`).classList.add('active');

            document.querySelectorAll('.xhs-canvas').forEach(el => el.classList.remove('active'));
            document.getElementById(`canvas-${tab}`).classList.add('active');
        }

        function setCoverTemplate(tpl) {
            state.cover.template = tpl;

            document.querySelectorAll('.template-card').forEach(el => el.classList.remove('active'));

            // ä¿®å¤ï¼šä¸ä¾èµ–å…¨å±€ event å¯¹è±¡
            const card = document.querySelector(`.template-card[onclick*="'${tpl}'"]`);
            if (card) {
                card.classList.add('active');
            }

            // åˆ‡æ¢ Contrast æ¨¡æ¿çš„è¾“å…¥å­—æ®µæ˜¾ç¤º
            const isContrast = tpl === 'contrast';
            const subtitleGroup = document.getElementById('coverSubtitleGroup');
            const contrastGroup = document.getElementById('coverContrastGroup');

            if (subtitleGroup) subtitleGroup.style.display = isContrast ? 'none' : 'block';
            if (contrastGroup) contrastGroup.style.display = isContrast ? 'block' : 'none';

            renderCover();
        }

        function updateCoverAlign(align) {
            state.cover.align = align;
            renderCover();
        }

        // åˆå§‹åŒ–é¢œè‰²å’Œè®¾ç½®ä¸»é¢˜
        function initColors() {
            const box = document.getElementById('themeColors');
            COLORS.forEach(c => {
                const d = document.createElement('div');
                d.className = `color-dot ${c === state.theme ? 'active' : ''}`;
                d.style.background = c;
                d.dataset.color = c;
                d.onclick = () => setTheme(c);
                box.appendChild(d);
            });

            const picker = document.getElementById('customColorPicker');
            const hexInput = document.getElementById('customColorHex');

            // ç»‘å®šè‡ªå®šä¹‰é¢œè‰²è¾“å…¥
            picker.addEventListener('input', (e) => {
                const color = e.target.value;
                hexInput.value = color.toUpperCase();
                setTheme(color);
            });

            hexInput.addEventListener('input', debounce((e) => {
                const color = e.target.value.trim().toUpperCase();
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    picker.value = color;
                    setTheme(color);
                }
            }, 300));

            // é¦–æ¬¡è®¾ç½®
            setTheme(state.theme);
        }

        function setTheme(color) {
            state.theme = color;
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '42, 0, 255';
            };
            const rgb = hexToRgb(color);
            const primaryLightRgba = `rgba(${rgb}, 0.1)`;

            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-light', primaryLightRgba);

            document.querySelectorAll('.color-dot').forEach(el => {
                el.classList.toggle('active', el.dataset.color === color);
            });

            // åŒæ­¥è‡ªå®šä¹‰é¢œè‰²è¾“å…¥
            const picker = document.getElementById('customColorPicker');
            const hexInput = document.getElementById('customColorHex');
            if (picker && hexInput) {
                picker.value = color;
                hexInput.value = color;
            }

            renderAll();
        }

        // === æ¸²æŸ“é€»è¾‘ï¼šå†…å®¹ ===

        function renderAll() {
            renderCover();
            renderTutorial();
            renderImage();
        }

        function renderCover() {
            const c = state.cover;
            const el = document.getElementById('canvas-cover');
            el.className = `xhs-canvas cover-canvas tpl-${c.template}`;

            if (c.template === 'thinking' || c.template === 'emotion') {
                el.style.justifyContent = c.align;
            } else {
                el.style.justifyContent = 'flex-start';
            }

            let html = '';
            if (c.template === 'thinking') {
                html = `
                <div class="cover-icon">${c.icon}</div>
                <div class="cover-title">${c.title}</div>
                <div class="cover-subtitle">${c.subtitle}</div>
            `;
            } else if (c.template === 'tutorial') {
                const titleHtml = c.title.length > 2
                    ? c.title.replace(/(.{2})$/, '<span>$1</span>')
                    : `<span>${c.title}</span>`;

                html = `
                <div class="tutorial-card">
                    <div class="cover-tag">ä¿å§†çº§æ•™ç¨‹</div>
                    <div class="cover-icon">${c.icon}</div>
                    <div class="cover-title">${titleHtml}</div>
                    <div class="cover-subtitle">${c.subtitle}</div>
                </div>
            `;
            } else if (c.template === 'emotion') {
                const date = new Date().toLocaleDateString('zh-CN', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
                html = `
                <div class="emotion-top">
                    <div class="cover-icon">${c.icon}</div>
                    <div class="cover-date">${date}</div>
                </div>
                <div>
                    <div class="cover-title">${c.title}</div>
                    <div class="cover-subtitle">${c.subtitle}</div>
                </div>
            `;
            } else if (c.template === 'contrast') {
                html = `
                <div class="cover-title">${c.title}</div>
                <div class="tpl-contrast-grid">
                    <div class="contrast-col contrast-col-left">
                        <div class="contrast-col-label">${c.leftLabel}</div>
                        <div class="contrast-col-body">${c.subtitleLeft}</div>
                    </div>
                    <div class="contrast-col contrast-col-right">
                        <div class="contrast-col-label">${c.rightLabel}</div>
                        <div class="contrast-col-body">${c.subtitleRight}</div>
                    </div>
                </div>
            `;
            }
            el.innerHTML = html;
            el.style.display = 'flex';
        }

        function renderTutorial() {
            const c = state.tutorial;

            const currentSteps = state.tutorial.steps.slice();

            const listHtml = currentSteps.map((step, i) => {
                const blocks = step.blocks.map(b => {
                    const valWithBreaks = b.val.replace(/\n/g, '<br>');

                    if (b.type === 'text') return `<div style="font-size:17px; margin-bottom:4px; line-height:1.6;">${valWithBreaks}</div>`;
                    if (b.type === 'prompt') return `<div class="comp-prompt">${valWithBreaks}</div>`;
                    if (b.type === 'image') return `<div class="comp-img"><img src="${b.val}"></div>`;
                    if (b.type === 'tip') return `<div class="comp-status-box comp-tip">${valWithBreaks}</div>`;
                    if (b.type === 'option') return `
                    <div class="comp-option">
                        <div class="option-bullet">ğŸ”˜</div>
                        <div class="option-text">${valWithBreaks}</div>
                    </div>`;
                    if (b.type === 'success') return `<div class="comp-status-box comp-success">${valWithBreaks}</div>`;
                    if (b.type === 'warning') return `<div class="comp-status-box comp-warning">${valWithBreaks}</div>`;

                    return '';
                }).join('');

                return `
                <div class="step-item">
                    <div class="step-left">
                        <div class="step-idx">${i + 1}</div>
                        <div class="step-line-segment"></div>
                    </div>
                    <div class="step-right">
                        ${blocks}
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('canvas-tutorial').innerHTML = `
            <div class="step-header">
                <div class="step-num">${c.num}</div>
                <div class="step-header-text">
                    <div class="step-header-en">${c.en}</div>
                    <div class="step-header-title">${c.title}</div>
                </div>
            </div>
            <div class="step-body">
                ${listHtml}
            </div>
            <div style="background:#000; color:#fff; padding:20px 40px; font-size:13px;">
                ${c.footer}
            </div>
        `;
        }

        // ä¼˜åŒ– 2: å›¾ç‰‡åˆ¶ä½œé¢„è§ˆåŒºæ¸²æŸ“
        function renderImage() {
            const c = state.image;

            const listHtml = c.blocks.map(step => {
                return step.blocks.map(b => {
                    const valWithBreaks = b.val.replace(/\n/g, '<br>');

                    if (b.type === 'text') return `<div style="font-size:17px; line-height:1.6; color:#444;">${valWithBreaks}</div>`;
                    if (b.type === 'prompt') return `<div class="comp-prompt">${valWithBreaks}</div>`;
                    if (b.type === 'image') return `<div class="comp-img"><img src="${b.val}"></div>`;
                    if (b.type === 'tip') return `<div class="comp-status-box comp-tip">${valWithBreaks}</div>`;
                    if (b.type === 'option') return `
                    <div class="comp-option">
                        <div class="option-bullet" style="background: var(--primary);">âœ”</div> 
                        <div class="option-text" style="font-size: 18px; font-weight: 600;">${valWithBreaks}</div>
                    </div>`;
                    if (b.type === 'success') return `<div class="comp-status-box comp-success">${valWithBreaks}</div>`;
                    if (b.type === 'warning') return `<div class="comp-status-box comp-warning">${valWithBreaks}</div>`;

                    return '';
                }).join('');
            }).join('');


            document.getElementById('canvas-image').innerHTML = `
            <div class="image-title">${c.title}</div>
            <div class="image-body">
                ${listHtml}
            </div>
            <div style="background:var(--primary); color:#fff; padding:20px 40px; font-size:16px; font-weight:600; text-align:center; flex-shrink: 0;">
                ${c.footer}
            </div>
        `;
        }

        // === ç¼–è¾‘å™¨æ„å»º (ä¸çŠ¶æ€åŒæ­¥) ===

        function renderEditors() {
            renderStepsEditor('tutorial', state.tutorial.steps, 'tutorialStepsContainer');
            renderStepsEditor('image', state.image.blocks, 'imageBlocksContainer', false);
        }

        function renderStepsEditor(tab, steps, containerId, isStep = true) {
            const div = document.getElementById(containerId);
            div.innerHTML = '';

            steps.forEach((step, sIdx) => {
                const blockInputs = step.blocks.map((b, bIdx) => {
                    const typeLabel = BLOCK_TYPE_LABELS[b.type] || b.type;

                    const isBase64 = b.val.startsWith('data:image/');
                    const displayVal = isBase64 ? `[å·²ä¸Šä¼ æœ¬åœ°å›¾ç‰‡: ${b.fileName || 'æœªçŸ¥æ–‡ä»¶å'}]` : b.val;

                    return `
                <div class="block-item" data-block-type="${b.type}" data-block-id="${step.id}-${bIdx}">
                    <span style="font-size:12px; color:#999; width:60px; cursor:move; flex-shrink:0; margin-top: 5px;">${typeLabel}</span>
                    <textarea class="form-control" 
                              oninput="updateBlock('${tab}', ${sIdx}, ${bIdx}, this.value); autoResizeTextarea(this);">${displayVal}</textarea>
                    <button class="tiny-btn" style="color:red; flex-shrink:0;" onclick="removeBlock('${tab}', ${sIdx}, ${bIdx})">Ã—</button>
                </div>
            `;
                }).join('');

                const card = document.createElement('div');
                card.className = 'step-edit-card';
                card.dataset.stepId = step.id;
                card.innerHTML = `
                <div class="step-top">
                    <span>${isStep ? 'æ­¥éª¤' : 'åŒºå—'} ${sIdx + 1}</span>
                    <button class="tiny-btn" onclick="removeStep('${tab}', ${sIdx})">åˆ é™¤</button>
                </div>
                <div class="block-list" data-step-index="${sIdx}">${blockInputs}</div>
                <div class="block-btn-bar">
                    <button class="tiny-btn" onclick="addBlock('${tab}', ${sIdx}, 'text')">ğŸ“ æ–‡æœ¬</button>
                    <button class="tiny-btn" onclick="addBlock('${tab}', ${sIdx}, 'prompt')">ğŸ’» æç¤ºè¯</button>
                    <button class="tiny-btn" onclick="addBlock('${tab}', ${sIdx}, 'image-url')">ğŸ–¼ï¸ å›¾ç‰‡ (URL)</button>
                    <button class="tiny-btn" style="background:#f0f0f0;" onclick="triggerLocalImageUpload('${tab}', ${sIdx})">â¬†ï¸ æœ¬åœ°ä¸Šä¼ </button>
                    <button class="tiny-btn" onclick="addBlock('${tab}', ${sIdx}, 'option')">ğŸ”˜ é€‰é¡¹</button>
                    <button class="tiny-btn" style="background:#fff3e0;" onclick="addBlock('${tab}', ${sIdx}, 'tip')">ğŸ’¡ è´´å£«</button>
                    <button class="tiny-btn" style="background:#e6ffed;" onclick="addBlock('${tab}', ${sIdx}, 'success')">âœ… æˆåŠŸ</button>
                    <button class="tiny-btn" style="background:#fff8e1;" onclick="addBlock('${tab}', ${sIdx}, 'warning')">âš ï¸ è­¦å‘Š</button>
                </div>
            `;
                div.appendChild(card);

                new Sortable(card.querySelector('.block-list'), { animation: 150, group: 'blocks', handle: 'span', onEnd: () => { updateStateFromDom(tab); } });

                // å¢å¼ºï¼šç¡®ä¿æ–°åˆ›å»ºçš„ textarea ç«‹å³åº”ç”¨ autoResizeTextarea
                card.querySelectorAll('textarea').forEach(autoResizeTextarea);
            });
        }


        // === å›¾ç‰‡ä¸Šä¼ /çŠ¶æ€åŒæ­¥ç­‰è¾…åŠ©å‡½æ•° [ä¿æŒä¸å˜] ===
        function triggerLocalImageUpload(tab, sIdx) {
            currentTabForUpload = tab;
            currentStepIdxForUpload = sIdx;
            document.getElementById('localImageInput').click();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file || currentStepIdxForUpload === -1) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Url = event.target.result;

                const targetSteps = state[currentTabForUpload].steps || state[currentTabForUpload].blocks;

                targetSteps[currentStepIdxForUpload].blocks.push({
                    type: 'image',
                    val: base64Url,
                    fileName: file.name
                });

                renderEditors();
                renderAll();

                currentStepIdxForUpload = -1;
                currentTabForUpload = '';
                e.target.value = '';
            };
            reader.readAsDataURL(file);
        }

        function updateStateFromDom(tab) {
            const containerId = tab === 'tutorial' ? 'tutorialStepsContainer' : 'imageBlocksContainer';
            const newSteps = [];
            document.getElementById(containerId).querySelectorAll('.step-edit-card').forEach((stepCard) => {
                const blocks = [];
                stepCard.querySelectorAll('.block-item').forEach(blockItem => {
                    const type = blockItem.dataset.blockType;
                    const textarea = blockItem.querySelector('textarea');
                    let val = textarea.value;
                    let fileName = '';

                    const oldStepsSource = state[tab].steps || state[tab].blocks;
                    const oldStep = oldStepsSource.find(s => s.id == stepCard.dataset.stepId);
                    const oldBlock = oldStep ? oldStep.blocks.find(b => b.val === val || b.val.startsWith('data:image/')) : null;

                    if (val.startsWith('[å·²ä¸Šä¼ æœ¬åœ°å›¾ç‰‡:')) {
                        if (oldBlock && oldBlock.val.startsWith('data:')) {
                            val = oldBlock.val;
                            fileName = oldBlock.fileName || val.match(/\[å·²ä¸Šä¼ æœ¬åœ°å›¾ç‰‡:\s*(.*?)\]/)?.[1] || '';
                        }
                    } else if (oldBlock && oldBlock.val.startsWith('data:')) {
                        fileName = '';
                    }

                    blocks.push({ type, val, fileName });
                });

                const oldStepsSource = state[tab].steps || state[tab].blocks;
                const oldStep = oldStepsSource.find(s => s.id == stepCard.dataset.stepId);
                newSteps.push({
                    id: oldStep ? oldStep.id : Date.now(),
                    blocks
                });
            });

            if (tab === 'tutorial') state.tutorial.steps = newSteps;
            else if (tab === 'image') state.image.blocks = newSteps;

            renderEditors();
            renderAll();
        }

        function convertNumToEnglish(numStr) {
            const num = parseInt(numStr, 10);
            const map = { 1: 'ONE', 2: 'TWO', 3: 'THREE', 4: 'FOUR', 5: 'FIVE', 6: 'SIX', 7: 'SEVEN', 8: 'EIGHT', 9: 'NINE', 10: 'TEN' };
            return 'STEP ' + (map[num] || numStr);
        }

        function addStep(tab) {
            const targetSteps = tab === 'tutorial' ? state.tutorial.steps : state.image.blocks;
            targetSteps.push({ id: Date.now(), blocks: [{ type: 'text', val: 'æ–°' + (tab === 'tutorial' ? 'æ­¥éª¤' : 'åŒºå—') + 'å†…å®¹' }] });
            renderEditors();
            renderAll();
        }

        function removeStep(tab, idx) {
            const targetSteps = tab === 'tutorial' ? state.tutorial.steps : state.image.blocks;
            targetSteps.splice(idx, 1);
            renderEditors();
            renderAll();
        }

        function addBlock(tab, sIdx, type) {
            const targetSteps = tab === 'tutorial' ? state.tutorial.steps : state.image.blocks;

            let val = 'æ–‡æœ¬å†…å®¹';
            if (type === 'image-url') {
                type = 'image'; val = 'https://picsum.photos/500/200'; // æ˜ç¡®å›¾ç‰‡ç±»å‹
            }
            else if (type === 'prompt') {
                val = 'ğŸ’» æç¤ºè¯å†…å®¹...';
            }
            else if (type === 'tip') {
                val = 'ğŸ’¡ é‡ç‚¹ï¼šè¿™ä¸ªæ“ä½œèƒ½èŠ‚çœä½ ä¸€åŠæ—¶é—´ï¼';
            }
            else if (type === 'option') {
                val = 'é€‰é¡¹å†…å®¹ï¼Œå¯ä½œä¸ºåˆ—è¡¨ä½¿ç”¨';
            }
            else if (type === 'success') {
                val = 'âœ… å®Œæˆï¼šæ­å–œä½ æˆåŠŸè§£é”æ–°æŠ€èƒ½ï¼';
            }
            else if (type === 'warning') {
                val = 'âš ï¸ æ³¨æ„ï¼šä¸è¦è½»æ˜“æ³„éœ²ä¸ªäººä¿¡æ¯ã€‚';
            }

            targetSteps[sIdx].blocks.push({ type, val });
            renderEditors();
            renderAll();
        }

        function removeBlock(tab, sIdx, bIdx) {
            const targetSteps = tab === 'tutorial' ? state.tutorial.steps : state.image.blocks;
            targetSteps[sIdx].blocks.splice(bIdx, 1);
            renderEditors();
            renderAll();
        }

        function updateBlock(tab, sIdx, bIdx, val) {
            const targetSteps = tab === 'tutorial' ? state.tutorial.steps : state.image.blocks;
            targetSteps[sIdx].blocks[bIdx].val = val;
            if (!val.startsWith('data:')) {
                targetSteps[sIdx].blocks[bIdx].fileName = '';
            }
            renderAll();
        }

        function initEmojis() {
            const box = document.getElementById('emojiPicker');
            EMOJIS.forEach(e => {
                const b = document.createElement('button');
                b.className = 'emoji-btn';
                b.innerText = e;
                b.onclick = () => {
                    const iconInput = document.getElementById('coverIcon');
                    iconInput.value = e;
                    state.cover.icon = e;
                    renderCover();
                };
                box.appendChild(b);
            });
        }

        // === å¯¼å‡ºåŠŸèƒ½ ===

        function exportImage() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            const targetId = `canvas-${state.tab}`;
            const target = document.getElementById(targetId);

            html2canvas(target, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: (state.tab === 'cover' && state.cover.template === 'emotion') ? null : '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `å°çº¢ä¹¦_${state.tab}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                loading.style.display = 'none';
            }).catch(err => {
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡é“¾æ¥æ˜¯å¦èƒ½è®¿é—®æˆ– Base64 å›¾ç‰‡æ•°æ®æ˜¯å¦æ­£ç¡®: ' + err);
                loading.style.display = 'none';
            });
        }
    </script>
</body>

</html>